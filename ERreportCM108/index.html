<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบรายงานผลเลือกตั้งเชียงใหม่ (Online v7.5 - Fixed)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700;800&family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs (Compat for HTML usage) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Prompt', sans-serif; overflow: hidden; background-color: #020617; }
        .bg-animated-container { background: #020617; position: absolute; inset: 0; overflow: hidden; z-index: -1; }
        .beam { position: absolute; width: 200vw; height: 40vh; background: linear-gradient(90deg, transparent 0%, rgba(30, 64, 175, 0.3) 25%, rgba(59, 130, 246, 0.7) 50%, rgba(30, 64, 175, 0.3) 75%, transparent 100% ); transform: rotate(-25deg); filter: blur(80px); pointer-events: none; z-index: 5; mix-blend-mode: screen; }
        .beam-1 { top: -20%; left: -50%; animation: sweep 12s infinite ease-in-out; }
        .beam-2 { top: 25%; left: -60%; animation: sweep 18s infinite ease-in-out reverse; }
        .beam-3 { top: 70%; left: -40%; animation: sweep 15s infinite ease-in-out; }
        @keyframes sweep { 0% { transform: translate(-15%, -5%) rotate(-25deg); } 50% { transform: translate(15%, 5%) rotate(-25deg); } 100% { transform: translate(-15%, -5%) rotate(-25deg); } }
        .glass-panel { background: rgba(2, 6, 23, 0.7); backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.6); }
        .page-transition { animation: slideInPage 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideInPage { from { transform: scale(0.98); opacity: 0; filter: blur(10px); } to { transform: scale(1); opacity: 1; filter: blur(0); } }
        .score-pop { animation: popScale 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popScale { 0% { transform: scale(1); color: #fff; } 50% { transform: scale(1.08); color: #fbbf24; } 100% { transform: scale(1); color: #fff; } }
        .candidate-card-enter { animation: slideIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .admin-scroll::-webkit-scrollbar { width: 10px; }
        .admin-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .admin-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 5px; }
        .dashboard-container { display: grid; grid-template-rows: 80px 1fr 40px; height: 100vh; width: 100vw; position: relative; overflow: hidden; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .text-shadow { text-shadow: 2px 2px 4px rgba(0,0,0,0.9); }
        .thai-text { line-height: 1.6 !important; padding-top: 4px; padding-bottom: 4px; display: block; }
        .img-fit { width: 100%; height: 100%; object-fit: cover; object-position: top; }
        .save-status-pop { animation: popOut 2s ease-out forwards; }
        @keyframes popOut { 0% { opacity: 0; transform: translateY(10px); } 20% { opacity: 1; transform: translateY(0); } 80% { opacity: 1; } 100% { opacity: 0; } }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        @media (max-width: 768px) { .dashboard-container { grid-template-rows: 60px 1fr 30px; } h2 { font-size: 1.5rem !important; } .score-main { font-size: 2rem !important; } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // ==========================================
        // --- ส่วนที่ต้องแก้ไขเพื่อให้ออนไลน์ได้ ---
        // ==========================================
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyC4xL7-ooqRwL8837vjn_X5fnrFfbYyrAc",
            authDomain: "election-results-report-cm108.firebaseapp.com",
            projectId: "election-results-report-cm108",
            storageBucket: "election-results-report-cm108.firebasestorage.app",
            messagingSenderId: "793102348089",
            appId: "1:793102348089:web:35c0a022e5dbf960f042e8",
            measurementId: "G-07QVSX6VLR"
        };
        // ==========================================

        let app, auth, db;
        let isInternalEnv = false;
        let configToUse = USER_FIREBASE_CONFIG;
        
        if (!configToUse) {
            try { 
                if (typeof __firebase_config !== 'undefined') {
                    configToUse = JSON.parse(__firebase_config); 
                    isInternalEnv = true;
                }
            } catch (e) {}
        }

        if (configToUse) {
            if (!firebase.apps.length) app = firebase.initializeApp(configToUse); 
            else app = firebase.app();
            auth = firebase.auth();
            db = firebase.firestore();
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'election-cm-2026';
        const getDocRef = () => {
            if (!db) return null;
            if (isInternalEnv) return db.collection('artifacts').doc(appId).collection('public').doc('data').collection('election').doc('main');
            return db.collection('election_data').doc('chiangmai_live');
        };

        const DEFAULT_PARTY_COLORS = { "วิชชั่นใหม่": "#14b8a6", "ประชาชน": "#ff7f00", "เศรษฐกิจ": "#f59e0b", "กล้าธรรม": "#8b5cf6", "ภูมิใจไทย": "#1e40af", "เพื่อไทย": "#dc2626", "ประชาธิปัตย์": "#3b82f6", "โอกาสใหม่": "#10b981", "รวมไทยสร้างชาติ": "#2563eb", "ไทยก้าวใหม่": "#6366f1", "รักชาติ": "#be123c", "เสรีรวมไทย": "#eab308", "ก้าวอิสระ": "#64748b", "พลังประชารัฐ": "#15803d", "ประชากรไทย": "#ec4899", "ปวงชนไทย": "#a855f7", "พลวัต": "#06b6d4", "เพื่อบ้านเมือง": "#f97316" };
        const ALL_SLIDES = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10]; 
        const INITIAL_DATA = {
            settings: { title: "ผลการนับคะแนนเลือกตั้ง ส.ส. เชียงใหม่ 10 เขต (ไม่เป็นทางการ)", footer: "ข้อมูลผลคะแนนเลือกตั้งเป็นเพียงผลไม่เป็นทางการ", cycleTime: 10, marqueeSpeed: 20, backgroundImage: "", displayMode: 'auto', activeSlide: 0, enabledSlides: ALL_SLIDES, showLightEffect: true, lightBrightness: 70 },
            partyColors: DEFAULT_PARTY_COLORS,
            districts: Array.from({length: 10}, (_, i) => ({ id: i + 1, name: `เขต ${i + 1}`, lastUpdated: null, candidates: Array.from({length: 12}, (_, j) => ({ no: j + 1, name: `ผู้สมัครคนที่ ${j + 1}`, party: Object.keys(DEFAULT_PARTY_COLORS)[j % Object.keys(DEFAULT_PARTY_COLORS).length], score: 0 })) }))
        };

        const getContrastColor = (hex) => {
            if (!hex || hex.length < 6) return 'text-white';
            const r = parseInt(hex.slice(1, 3), 16); const g = parseInt(hex.slice(3, 5), 16); const b = parseInt(hex.slice(5, 7), 16);
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (yiq >= 150) ? 'text-slate-900' : 'text-white';
        };

        async function imageUrlToBase64(url) {
            if (!url || url.startsWith('data:')) return url;
            try {
                const response = await fetch(url); const blob = await response.blob();
                return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onloadend = () => resolve(reader.result); reader.onerror = reject; reader.readAsDataURL(blob); });
            } catch (error) { return url; }
        }

        // --- Icons ---
        function Icon({ children, size = 24, className = "" }) { return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>; }
        function SaveIcon(p) { return <Icon {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>; }
        function MonitorIcon(p) { return <Icon {...p}><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></Icon>; }
        function GlobeIcon(p) { return <Icon {...p}><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></Icon>; }
        function CameraIcon(p) { return <Icon {...p}><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></Icon>; }
        function DownloadIcon(p) { return <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></Icon>; }
        function ImageIcon(p) { return <Icon {...p}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></Icon>; }
        function ArrowUpIcon(p) { return <Icon {...p}><polyline points="18 15 12 9 6 15"/></Icon>; }
        function ArrowDownIcon(p) { return <Icon {...p}><polyline points="6 9 12 15 18 9"/></Icon>; }
        function CheckIcon(p) { return <Icon {...p}><polyline points="20 6 9 17 4 12"/></Icon>; }
        function LoaderIcon(p) { return <Icon {...p} className={`animate-spin ${p.className}`}><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/></Icon>; }
        function SettingsIcon(p) { return <Icon {...p}><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></Icon>; }
        function UsersIcon(p) { return <Icon {...p}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></Icon>; }
        function PaletteIcon(p) { return <Icon {...p}><circle cx="13.5" cy="6.5" r=".5"></circle><circle cx="17.5" cy="10.5" r=".5"></circle><circle cx="8.5" cy="7.5" r=".5"></circle><circle cx="6.5" cy="12.5" r=".5"></circle><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"></path></Icon>; }

        function Clock({ onClick }) {
            const [time, setTime] = useState(new Date());
            useEffect(() => { const timer = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(timer); }, []);
            return (
                <div className="text-right cursor-pointer group select-none pointer-events-auto relative z-50 flex items-center gap-4" onClick={onClick}>
                     <div className="hidden group-hover:block text-xs bg-white text-blue-900 px-2 py-1 rounded font-bold uppercase animate-pulse">Click for Admin</div>
                    <div>
                        <div className="text-3xl font-mono font-bold text-white leading-none group-hover:text-blue-400 transition-colors">
                            {time.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}
                        </div>
                        <div className="text-sm text-blue-200 mt-1">
                            {time.toLocaleDateString('th-TH', {day:'numeric', month:'long', year:'numeric'})}
                        </div>
                    </div>
                </div>
            );
        }

        function DistrictView({ district, partyColors }) {
            if (!district) return null;
            const sorted = [...district.candidates].sort((a, b) => b.score - a.score);
            const getColor = (p) => partyColors[p] || "#64748b";
            const top3 = [sorted[0], sorted[1], sorted[2]];
            return (
                <div className="flex-1 px-8 py-4 relative h-full flex flex-col pt-8 page-transition">
                    <div className="flex justify-between items-end mb-4 z-10 relative h-auto shrink-0 -mt-8"> 
                        <div>
                            <h2 className="text-[3.1rem] font-bold text-white mb-0 drop-shadow-md flex items-center text-shadow thai-text uppercase">
                                <span className="px-4 py-1.5 rounded-lg mr-4 text-[1.9rem] shadow-lg text-white" style={{backgroundColor: getColor(sorted[0]?.party)}}>เชียงใหม่</span>
                                {district.name}
                            </h2>
                            <div className="text-blue-200 text-xl flex items-center mt-0.5 font-medium ml-1"> 
                                <div className={`w-3.5 h-3.5 rounded-full mr-2 ${district.lastUpdated ? 'bg-green-500 animate-pulse' : 'bg-gray-500'} shadow-[0_0_10px_currentColor]`}></div>
                                อัปเดตล่าสุด: {district.lastUpdated || "รอคะแนน"}
                            </div>
                        </div>
                        <div className="text-right">
                            <div className="text-blue-200 text-xl mb-1 font-bold uppercase tracking-widest text-shadow">นับแล้ว (คะแนน)</div>
                            <div key={district.candidates.reduce((a,b)=>a+b.score, 0)} className="text-[3.2rem] font-bold text-white text-shadow tracking-widest score-pop leading-none">
                                {district.candidates.reduce((a,b)=>a+b.score, 0).toLocaleString()}
                            </div>
                        </div>
                    </div>
                    <div className="flex gap-6 mb-3 z-10 relative h-[42%] shrink-0 items-end">
                        {top3.map((c, i) => {
                            const is1 = i === 0; const color = getColor(c?.party);
                            return (
                                <div key={i} className={`${is1 ? 'flex-[1.6] h-[100%]' : 'flex-1 h-[90%]'} relative rounded-[1.25rem] p-4 flex flex-row items-center gap-4 shadow-2xl transition-all duration-500`} style={{background: `linear-gradient(135deg, ${color}cc, ${color}66)`, border: is1 ? '2.5px solid white' : '1px solid rgba(255,255,255,0.2)'}}>
                                    <div className={`absolute -top-3.5 -right-3.5 ${is1 ? 'text-[1.6rem] w-14 h-14' : 'text-[1.4rem] w-12 h-12'} font-black rounded-full flex items-center justify-center shadow-lg border-2 bg-white text-blue-900 z-20`}>{i+1}</div>
                                    <div className="h-full w-[40%] relative flex-shrink-0 flex items-center justify-center">
                                        <div className="h-full w-auto aspect-[3/4] rounded-xl border-2 border-white/30 overflow-hidden bg-slate-800 shadow-2xl relative">
                                            <img src={c?.image || `https://placehold.co/150x200/${color.replace('#','')}/FFFFFF?text=${c?.no}`} className="img-fit"/>
                                        </div>
                                        <div className="absolute -bottom-3 left-1/2 transform -translate-x-1/2 bg-white text-blue-900 font-bold px-3.5 py-1 rounded-full shadow-xl text-sm whitespace-nowrap">เบอร์ {c?.no}</div>
                                    </div>
                                    <div className="flex-1 flex flex-col justify-center h-full min-w-0">
                                        <h3 className={`text-white font-semibold leading-tight thai-text ${is1 ? 'text-[1.9rem]' : 'text-[1.3rem]'}`}>{c?.name}</h3>
                                        <div className="mt-2.5 mb-2.5">
                                            <span className={`font-bold px-3.5 py-1 rounded-full border border-white/20 bg-black/20 text-base ${getContrastColor(color)}`} style={{backgroundColor: color}}>{c?.party}</span>
                                        </div>
                                        <div key={c?.score} className={`${is1 ? 'text-[3.8rem]' : 'text-[2.6rem]'} font-black text-white text-shadow score-pop leading-none`}>
                                            {c?.score.toLocaleString()}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    <div className="flex-1 relative grid grid-cols-4 gap-x-3 gap-y-2.5 content-start overflow-hidden pt-2 pb-2">
                        {sorted.slice(3).map((c, idx) => (
                            <div key={idx} className="flex items-center bg-gray-900/80 rounded-xl p-2 border border-white/10 h-[5.25rem] candidate-card-enter shadow-md">
                                <div className="h-full aspect-[3/4] rounded-lg bg-gray-700 mr-2 shrink-0 overflow-hidden border relative flex justify-center items-center" style={{borderColor: getColor(c.party)}}>
                                    <img src={c.image || `https://placehold.co/150x200/${getColor(c.party).replace('#','')}/FFFFFF?text=${c.no}`} className="img-fit"/>
                                </div>
                                <div className="flex-1 min-w-0 mr-1 flex flex-col justify-center h-full overflow-visible">
                                    <div className="text-white text-[17.4px] font-semibold truncate text-shadow thai-text leading-normal py-0.5">{c.name}</div>
                                    <div className="mt-1 overflow-visible flex items-center gap-1.5">
                                        <span className={`text-[13.3px] font-medium px-3 py-0.5 rounded-full border border-white/20 inline-block align-middle leading-normal shadow-sm ${getContrastColor(getColor(c.party))}`} style={{backgroundColor: getColor(c.party), textShadow: getContrastColor(getColor(c.party)) === 'text-white' ? '1px 1px 2px rgba(0,0,0,0.5)' : 'none'}}>{c.party}</span>
                                        <span className="bg-white text-blue-900 text-[13.3px] px-3 py-0.5 rounded-full font-bold shadow-md border border-white inline-block align-middle leading-normal shrink-0">เบอร์ {c.no}</span>
                                    </div>
                                </div>
                                <div key={c.score} className="text-[1.6rem] font-bold text-white w-20 text-right text-shadow score-pop">{c.score.toLocaleString()}</div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function SummaryView({ data, partyColors }) {
            if (!data) return null;
            const getColor = (p) => partyColors[p] || "#64748b";
            const winners = data.districts.map(d => ({ district: d.name, winner: [...d.candidates].sort((a,b) => b.score - a.score)[0] }));
            return (
                <div className="px-8 py-2 h-full flex flex-col relative z-10 page-transition">
                    <div className="text-center mb-1 shrink-0">
                        <h2 className="text-[2.5rem] font-bold text-white drop-shadow-md text-shadow thai-text leading-none uppercase">ภาพรวมการนับคะแนนเลือกตั้ง ส.ส. เชียงใหม่ 10 เขต</h2>
                        <div className="text-[1.4rem] font-normal text-blue-200 opacity-75 mt-3 leading-none italic">(ไม่เป็นทางการ)</div>
                    </div>
                    <div className="grid grid-cols-5 grid-rows-2 gap-3 flex-1 h-full min-h-0 py-2">
                        {winners.map((item, idx) => {
                            const partyColor = getColor(item.winner.party);
                            const contrastClass = getContrastColor(partyColor);
                            return (
                                <div key={idx} className="glass-panel rounded-[1.4rem] p-2.5 flex flex-col items-center justify-between text-center relative overflow-hidden h-full shadow-2xl transition-transform hover:scale-[1.04]" style={{ background: `radial-gradient(circle at 50% 0%, ${partyColor}33, rgba(2, 6, 23, 0.95))` }}>
                                    <div className="absolute top-0 left-0 w-full h-1" style={{backgroundColor: partyColor}}></div>
                                    <div className="w-full flex justify-center mb-1 shrink-0">
                                        <div className="bg-white/5 px-4 py-0.5 rounded-full border border-white/10 shadow-sm backdrop-blur-sm">
                                            <span className="text-blue-50 text-[1.1rem] font-bold uppercase tracking-wider leading-none drop-shadow-md">{item.district}</span>
                                        </div>
                                    </div>
                                    <div className="relative mb-1 flex-1 flex items-center justify-center w-full min-h-0 px-0.5">
                                        <div className="h-full w-auto aspect-[3/4] rounded-md border-2 border-white/20 overflow-hidden shadow-2xl bg-slate-800 relative" style={{borderColor: partyColor}}>
                                            <img src={item.winner.image || `https://placehold.co/150x200/${partyColor.replace('#','')}/FFFFFF?text=${item.winner.no}`} className="img-fit opacity-95"/>
                                            <div className="absolute -bottom-0.5 left-1/2 -translate-x-1/2 bg-white text-blue-900 px-2.5 py-0.5 rounded-full shadow-xl border border-white z-20 whitespace-nowrap text-[10px] font-black">เบอร์ {item.winner.no}</div>
                                        </div>
                                    </div>
                                    <div className="w-full mt-0 pb-1 shrink-0">
                                        <div className="text-white text-[1.2rem] font-semibold truncate w-full px-1 thai-text text-shadow leading-none mb-1.5">{item.winner.name}</div>
                                        <div className={`text-[13px] font-medium px-4 py-0.5 rounded-full border border-white/10 inline-block align-middle leading-normal shadow-sm ${contrastClass}`} style={{ backgroundColor: partyColor }}>{item.winner.party}</div>
                                        <div key={item.winner.score} className="text-[1.85rem] font-bold text-white text-shadow tracking-normal leading-tight mt-1.5 score-pop">
                                            {item.winner.score.toLocaleString()}
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        // --- New Component: ImageUploadModal ---
        function ImageUploadModal({ isOpen, onClose, onSave, districtId, candidateNo, initialUrl }) {
            const [mode, setMode] = useState('url');
            const [tempUrl, setTempUrl] = useState(initialUrl || '');
            const fileInputRef = useRef(null);

            useEffect(() => {
                setTempUrl(initialUrl || '');
                setMode('url');
            }, [initialUrl, isOpen]);

            if (!isOpen) return null;

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                        const maxWidth = 400; const scale = Math.min(1, maxWidth / img.width);
                        canvas.width = img.width * scale; canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        setTempUrl(canvas.toDataURL('image/jpeg', 0.8)); setMode('upload');
                    }
                };
                reader.readAsDataURL(file);
            };

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-[fadeIn_0.2s]">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="bg-slate-100 px-6 py-4 border-b flex justify-between items-center">
                            <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><ImageIcon size={20} className="text-blue-600"/> จัดการรูปภาพผู้สมัคร</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-red-500"><Icon size={24}><path d="M18 6L6 18M6 6l12 12"/></Icon></button>
                        </div>
                        <div className="p-6 flex-1 overflow-y-auto">
                            <div className="flex justify-center mb-6">
                                <div className="w-32 h-44 bg-slate-200 rounded-lg shadow-inner border-2 border-white ring-2 ring-slate-100 overflow-hidden relative group">
                                    {tempUrl ? <img src={tempUrl} className="w-full h-full object-cover bg-white" /> : <div className="flex flex-col items-center justify-center h-full text-slate-400"><ImageIcon size={32} className="opacity-20 mb-2"/><span className="text-xs font-bold">No Image</span></div>}
                                </div>
                            </div>
                            <div className="flex bg-slate-100 p-1 rounded-xl mb-6">
                                <button onClick={() => setMode('url')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${mode === 'url' ? 'bg-white shadow text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}><span className="flex items-center justify-center gap-2"><GlobeIcon size={14}/> ใช้ URL รูปภาพ</span></button>
                                <button onClick={() => setMode('upload')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${mode === 'upload' ? 'bg-white shadow text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}><span className="flex items-center justify-center gap-2"><CameraIcon size={14}/> อัปโหลดไฟล์</span></button>
                            </div>
                            {mode === 'url' ? (
                                <div className="space-y-3 animate-[fadeIn_0.3s]">
                                    <label className="text-xs font-bold text-slate-500 uppercase ml-1">วางลิงก์รูปภาพ</label>
                                    <input type="text" value={tempUrl.startsWith('data:') ? '' : tempUrl} onChange={(e) => setTempUrl(e.target.value)} placeholder="https://..." className="w-full border-2 border-slate-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-blue-500"/>
                                </div>
                            ) : (
                                <div className="space-y-3 animate-[fadeIn_0.3s]">
                                    <div className="text-center py-8 border-2 border-dashed border-slate-300 rounded-xl hover:border-blue-500 hover:bg-blue-50/50 cursor-pointer bg-slate-50 group" onClick={() => fileInputRef.current.click()}>
                                        <div className="mx-auto w-14 h-14 bg-white shadow-sm border text-blue-500 rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition-transform"><Icon size={24}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></Icon></div>
                                        <div className="text-sm font-bold text-slate-600">คลิกเพื่อเลือกไฟล์</div>
                                    </div>
                                    <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleFileChange}/>
                                </div>
                            )}
                        </div>
                        <div className="p-4 bg-slate-50 border-t flex gap-3">
                            <button onClick={onClose} className="flex-1 py-3 text-sm font-bold text-slate-500 hover:bg-slate-200 rounded-xl">ยกเลิก</button>
                            <button onClick={() => onSave(districtId, candidateNo, tempUrl)} className="flex-[2] py-3 text-sm font-bold bg-blue-600 text-white hover:bg-blue-700 rounded-xl shadow-lg flex items-center justify-center gap-2"><SaveIcon size={18}/> บันทึก</button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- New Component: PartyColorModal ---
        function PartyColorModal({ isOpen, onClose, currentColors, onUpdate }) {
            const [colors, setColors] = useState(currentColors || {});
            const [newPartyName, setNewPartyName] = useState("");
            const [newPartyColor, setNewPartyColor] = useState("#000000");

            useEffect(() => { setColors(currentColors || {}); }, [currentColors, isOpen]);

            if (!isOpen) return null;

            const handleColorChange = (party, color) => setColors(prev => ({ ...prev, [party]: color }));
            const handleAdd = () => {
                if (newPartyName.trim()) {
                    setColors(prev => ({ ...prev, [newPartyName.trim()]: newPartyColor }));
                    setNewPartyName(""); setNewPartyColor("#000000");
                }
            };
            const handleRemove = (party) => { if(confirm(`ลบพรรค ${party}?`)) { const next = { ...colors }; delete next[party]; setColors(next); } };
            const handleSave = () => { onUpdate(colors); onClose(); };

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-[fadeIn_0.2s]">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[85vh]">
                        <div className="bg-slate-100 px-6 py-4 border-b flex justify-between items-center">
                            <h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><PaletteIcon size={20} className="text-pink-600"/> จัดการสีพรรคการเมือง</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-red-500"><Icon size={24}><path d="M18 6L6 18M6 6l12 12"/></Icon></button>
                        </div>
                        <div className="p-6 overflow-y-auto flex-1">
                            <div className="flex gap-2 mb-6 bg-slate-50 p-4 rounded-xl border border-slate-200 items-center">
                                <input type="text" value={newPartyName} onChange={e => setNewPartyName(e.target.value)} placeholder="ชื่อพรรคใหม่..." className="flex-1 px-3 py-2 rounded-lg border outline-none text-sm" />
                                <div className="flex items-center gap-1 border rounded-lg bg-white px-2 py-1">
                                    <input type="color" value={newPartyColor} onChange={e => setNewPartyColor(e.target.value)} className="w-6 h-6 rounded cursor-pointer border-none bg-transparent" />
                                    <input type="text" value={newPartyColor} onChange={e => setNewPartyColor(e.target.value)} className="w-16 text-xs font-mono uppercase outline-none" maxLength={7} />
                                </div>
                                <button onClick={handleAdd} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md hover:bg-blue-700">เพิ่ม</button>
                            </div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                {Object.entries(colors).map(([party, color]) => (
                                    <div key={party} className="flex items-center gap-3 p-2 border rounded-lg hover:border-blue-400 bg-white shadow-sm">
                                        <div className="flex items-center gap-1 border rounded bg-slate-50 px-1.5 py-1 shrink-0">
                                            <input type="color" value={color} onChange={(e) => handleColorChange(party, e.target.value)} className="w-5 h-5 rounded cursor-pointer border-none bg-transparent" />
                                            <input type="text" value={color} onChange={(e) => handleColorChange(party, e.target.value)} className="w-14 text-[10px] font-mono uppercase outline-none bg-transparent" maxLength={7} />
                                        </div>
                                        <span className="flex-1 font-medium text-sm truncate">{party}</span>
                                        <button onClick={() => handleRemove(party)} className="text-slate-300 hover:text-red-500 p-1"><Icon size={16}><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></Icon></button>
                                    </div>
                                ))}
                            </div>
                        </div>
                        <div className="p-4 border-t flex justify-end gap-3 bg-slate-50">
                            <button onClick={onClose} className="px-4 py-2 rounded-lg text-slate-600 font-bold hover:bg-slate-200">ยกเลิก</button>
                            <button onClick={handleSave} className="px-6 py-2 rounded-lg bg-pink-600 text-white font-bold shadow-lg hover:bg-pink-700 flex items-center gap-2"><SaveIcon size={16}/> บันทึก</button>
                        </div>
                    </div>
                </div>
            );
        }

        function AdminPanel({ localData, setLocalData, handleScoreChange, handleSettingChange, saveData, handleCandidateInfoChange, handleImageChange, isOnlineMode, saveTriggered, handleBgUpload, setMode, setupError }) {
            const importRef = useRef(null);
            const bgInputRef = useRef(null);
            const [isExporting, setIsExporting] = useState(false);
            const [autoStatus, setAutoStatus] = useState('idle'); 
            const [adminFilter, setAdminFilter] = useState('all'); 
            const [imageModalData, setImageModalData] = useState(null);
            const [isPartyModalOpen, setIsPartyModalOpen] = useState(false);

            if (!localData || !localData.districts) return <div className="h-screen flex items-center justify-center"><div className="loader"></div></div>;
            
            const syncImmediate = async (updatedData) => {
                try {
                    if (isOnlineMode) {
                        const docRef = getDocRef(); if(docRef) await docRef.set(updatedData);
                    } else {
                        localStorage.setItem('electionData', JSON.stringify(updatedData)); window.dispatchEvent(new Event('storage'));
                    }
                } catch(e) { console.error("Sync Error:", e); }
            };

            const setDisplayModeImmediate = async (mode, slide = 0) => {
                setAutoStatus('processing');
                const newData = { ...localData, settings: { ...localData.settings, displayMode: mode, activeSlide: parseInt(slide) } };
                setLocalData(newData); await syncImmediate(newData); setAutoStatus('success'); setTimeout(() => setAutoStatus('idle'), 2000);
            };

            const handleLightUpdate = async (field, value) => {
                const updatedData = { ...localData, settings: { ...localData.settings, [field]: value } };
                setLocalData(updatedData); await syncImmediate(updatedData);
            };

            const handlePartyColorUpdate = async (newColors) => {
                const updatedData = { ...localData, partyColors: newColors };
                setLocalData(updatedData); await syncImmediate(updatedData);
            };

            const toggleSlideEnabled = (idx) => {
                let enabled = [...(localData.settings.enabledSlides || ALL_SLIDES)];
                if (enabled.includes(idx)) { if (enabled.length > 1) enabled = enabled.filter(s => s !== idx); } else { enabled.push(idx); enabled.sort((a,b) => a-b); }
                handleSettingChange('enabledSlides', enabled);
            };

            const setEnabledShortcut = (type) => {
                let list = [];
                if (type === 'all') list = [...ALL_SLIDES];
                else if (type === 'districts') list = [0,1,2,3,4,5,6,7,8,9];
                else if (type === 'odd') list = [0,2,4,6,8];
                else if (type === 'even') list = [1,3,5,7,9];
                else if (type === 'summary') list = [10];
                handleSettingChange('enabledSlides', list);
            };

            const handleMove = (districtId, index, dir) => {
                const newDistricts = localData.districts.map(d => { if (d.id !== districtId) return d; const cands = [...d.candidates]; [cands[index], cands[index + dir]] = [cands[index + dir], cands[index]]; return { ...d, candidates: cands }; });
                setLocalData({ ...localData, districts: newDistricts });
            };

            const handleFullBackup = async () => {
                setIsExporting(true); const fullData = JSON.parse(JSON.stringify(localData));
                for (const dist of fullData.districts) { for (const cand of dist.candidates) { if (cand.image && cand.image.startsWith('http')) cand.image = await imageUrlToBase64(cand.image); } }
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(fullData));
                const node = document.createElement('a'); node.href = dataStr; node.download = `backup_election_v7.5.json`; node.click(); setIsExporting(false);
            };

            const handleImageModalSave = (distId, cNo, newUrl) => { handleImageChange(distId, cNo, newUrl); setImageModalData(null); };
            const enabledSlides = localData.settings.enabledSlides || ALL_SLIDES;

            return (
                <div className="h-screen bg-slate-50 flex flex-col overflow-hidden font-sans text-slate-800 relative">
                    {setupError && <div className="bg-red-600 text-white px-6 py-3 text-center text-sm font-bold shadow-lg z-[100] animate-bounce">{setupError}</div>}
                    
                    <ImageUploadModal isOpen={!!imageModalData} onClose={() => setImageModalData(null)} onSave={handleImageModalSave} {...imageModalData} />
                    <PartyColorModal isOpen={isPartyModalOpen} onClose={() => setIsPartyModalOpen(false)} currentColors={localData.partyColors} onUpdate={handlePartyColorUpdate} />
                    
                    <nav className="bg-white border-b px-8 py-3 flex justify-between items-center z-50 shrink-0 shadow-md">
                        <div className="flex items-center gap-3">
                            <button onClick={() => setMode('viewer')} className="bg-slate-100 hover:bg-slate-200 p-2 rounded-lg text-slate-600 transition-colors"><MonitorIcon size={20}/></button>
                            <h1 className="text-xl font-black uppercase tracking-tighter">ADMIN PANEL <span className="text-xs font-normal border px-2 py-0.5 rounded-full ml-1 opacity-50 uppercase">v7.5 COLORS</span></h1>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className={`text-[9px] px-3 py-1 rounded-full font-black border uppercase tracking-widest flex items-center gap-2 ${isOnlineMode && !setupError ? 'bg-green-50 text-green-600 border-green-200' : 'bg-orange-50 text-orange-600 border-orange-200'}`}>
                                <div className={`w-2 h-2 rounded-full ${isOnlineMode && !setupError ? 'bg-green-500 animate-pulse' : 'bg-orange-500'}`}></div>
                                {isOnlineMode && !setupError ? 'Online Real-time' : 'Offline Mode'}
                            </div>
                            <button onClick={() => setIsPartyModalOpen(true)} className="text-xs font-bold text-pink-600 hover:text-pink-700 px-3 py-1.5 bg-pink-50 rounded-lg border border-pink-100 flex items-center gap-2 transition-all hover:scale-105 shadow-sm"><PaletteIcon size={14}/> จัดการสีพรรค</button>
                            <div className="h-6 w-px bg-slate-200 mx-2"></div>
                            <button onClick={() => importRef.current.click()} className="text-xs font-bold text-slate-500 hover:text-blue-600 px-3 py-1.5 bg-slate-100 rounded-lg transition-colors">กู้คืนข้อมูล</button>
                            <input type="file" ref={importRef} className="hidden" accept=".json" onChange={(e) => { const r=new FileReader(); r.onload=(ev)=>setLocalData(JSON.parse(ev.target.result)); r.readAsText(e.target.files[0]); }}/>
                            <button onClick={handleFullBackup} disabled={isExporting} className="text-xs font-bold text-blue-600 hover:text-blue-700 px-3 py-1.5 bg-blue-50 rounded-lg border border-blue-100 flex items-center gap-2 transition-all">{isExporting ? 'กำลัง...' : <><DownloadIcon size={14}/> สำรอง</> }</button>
                        </div>
                    </nav>

                    <div className="flex-1 overflow-y-auto admin-scroll p-6">
                        <div className="max-w-7xl mx-auto space-y-6">
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                <div className="lg:col-span-1 flex flex-col gap-6">
                                    <div className="bg-white rounded-2xl border-2 border-blue-500 p-5 shadow-xl">
                                        <h3 className="text-sm font-black text-blue-600 uppercase mb-4 flex items-center gap-2"><MonitorIcon size={16}/> Live Monitor Control</h3>
                                        <div className="space-y-4">
                                            <button onClick={() => setDisplayModeImmediate('auto')} disabled={autoStatus === 'processing'} className={`w-full py-3 rounded-xl text-xs font-black shadow transition-all flex items-center justify-center gap-2 ${ autoStatus === 'success' ? 'bg-green-100 text-green-700 border-2 border-green-500 scale-105' : localData.settings.displayMode === 'auto' ? 'bg-green-600 text-white scale-105 ring-4 ring-green-100 animate-pulse' : 'bg-slate-100 text-slate-400 hover:bg-slate-200' }`}>
                                                {autoStatus === 'processing' ? <LoaderIcon size={16}/> : autoStatus === 'success' ? <CheckIcon size={16}/> : null} {autoStatus === 'processing' ? 'กำลังส่งคำสั่ง...' : autoStatus === 'success' ? 'ส่งคำสั่งสำเร็จ!' : 'วนลูปอัตโนมัติ (AUTO LOOP)'}
                                            </button>
                                            <div className="flex flex-col gap-1.5">
                                                <span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Force Show Specific Slide</span>
                                                <select value={localData.settings.displayMode === 'fixed' ? localData.settings.activeSlide : -1} onChange={(e) => setDisplayModeImmediate('fixed', e.target.value)} className="w-full bg-slate-50 border-2 rounded-xl px-3 py-2.5 text-xs font-black outline-none focus:border-blue-400 transition-all shadow-inner">
                                                    <option value="-1" disabled>เลือกหน้าที่จะบังคับแสดง...</option>
                                                    {localData.districts.map((d, i) => <option key={i} value={i}>{d.name}</option>)}
                                                    <option value="10">หน้าภาพรวม 10 เขต</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="bg-white rounded-2xl border-2 border-slate-100 p-5 shadow-lg">
                                        <h3 className="text-sm font-black text-slate-800 uppercase mb-4 flex items-center gap-2"><CheckIcon size={18}/> Auto Loop Playlist</h3>
                                        <div className="grid grid-cols-4 gap-2 mb-4">
                                            {ALL_SLIDES.map(idx => (<button key={idx} onClick={() => toggleSlideEnabled(idx)} className={`py-2 rounded-lg text-[10px] font-bold border transition-all ${enabledSlides.includes(idx) ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-slate-50 text-slate-400 border-slate-200'}`}>{idx === 10 ? 'รวม' : `ข.${idx+1}`}</button>))}
                                        </div>
                                        <div className="flex flex-wrap gap-1.5 pt-2 border-t">
                                            <button onClick={() => setEnabledShortcut('all')} className="text-[9px] font-black bg-slate-100 px-2 py-1 rounded hover:bg-slate-200 uppercase">เลือกหมด</button>
                                            <button onClick={() => setEnabledShortcut('districts')} className="text-[9px] font-black bg-slate-100 px-2 py-1 rounded hover:bg-slate-200 uppercase">1-10</button>
                                            <button onClick={() => setEnabledShortcut('summary')} className="text-[9px] font-black bg-slate-100 px-2 py-1 rounded hover:bg-slate-200 uppercase">สรุป</button>
                                        </div>
                                    </div>
                                </div>

                                <div className="lg:col-span-2 bg-white rounded-2xl border-2 border-slate-100 p-5 shadow-lg h-fit">
                                    <div className="flex justify-between items-center mb-4"><h3 className="text-sm font-black text-slate-800 uppercase flex items-center gap-2"><SettingsIcon size={18}/> System Configuration</h3><button onClick={() => saveData()} className="bg-slate-800 text-white px-5 py-2 rounded-xl text-xs font-black uppercase active:scale-95 shadow-lg flex items-center gap-2 transition-all"><SaveIcon size={14}/> Save Changes</button></div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                        <div className="space-y-1.5"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Main Title</label><input type="text" value={localData.settings.title} onChange={(e)=>handleSettingChange('title', e.target.value)} className="w-full border-2 border-slate-50 bg-slate-50 rounded-xl px-4 py-2 text-xs font-bold focus:bg-white focus:border-blue-300 outline-none transition-all"/></div>
                                        <div className="space-y-1.5"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Running Text (Footer)</label><input type="text" value={localData.settings.footer} onChange={(e)=>handleSettingChange('footer', e.target.value)} className="w-full border-2 border-slate-50 bg-slate-50 rounded-xl px-4 py-2 text-xs font-bold focus:bg-white focus:border-blue-300 outline-none transition-all"/></div>
                                        <div className="space-y-1.5">
                                            <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Background Image</label>
                                            <div className="flex gap-2">
                                                <input type="text" placeholder="URL หรือ Upload" value={localData.settings.backgroundImage || ''} onChange={(e) => handleSettingChange('backgroundImage', e.target.value)} className="flex-1 border-2 border-slate-50 bg-slate-50 rounded-xl px-4 py-2 text-[10px] font-bold outline-none focus:bg-white focus:border-blue-300 transition-all"/>
                                                <button onClick={() => bgInputRef.current.click()} className="bg-blue-50 text-blue-600 px-3 rounded-xl hover:bg-blue-100 transition-colors border border-blue-100"><ImageIcon size={14}/></button>
                                                <input type="file" ref={bgInputRef} onChange={(e) => handleBgUpload(e.target.files[0])} className="hidden" accept="image/*"/>
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-4">
                                            <div className="space-y-1.5"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Loop Time (Sec)</label><input type="number" value={localData.settings.cycleTime || 10} onChange={(e)=>handleSettingChange('cycleTime', parseInt(e.target.value))} className="w-full border-2 border-slate-50 bg-slate-50 rounded-xl px-4 py-2 text-xs font-bold focus:bg-white focus:border-blue-300 outline-none transition-all"/></div>
                                            <div className="space-y-1.5"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Marquee Speed</label><input type="number" value={localData.settings.marqueeSpeed || 20} onChange={(e)=>handleSettingChange('marqueeSpeed', parseInt(e.target.value))} className="w-full border-2 border-slate-50 bg-slate-50 rounded-xl px-4 py-2 text-xs font-bold focus:bg-white focus:border-blue-300 outline-none transition-all"/></div>
                                        </div>
                                        <div className="grid grid-cols-2 gap-4 p-3 bg-blue-50 rounded-2xl border border-blue-100 md:col-span-2">
                                            <div className="space-y-1.5">
                                                <label className="text-[10px] font-black text-blue-500 uppercase tracking-widest ml-1">Visual Effect</label>
                                                <div className="flex items-center gap-2">
                                                    <button onClick={() => handleLightUpdate('showLightEffect', !localData.settings.showLightEffect)} className={`w-full py-1.5 rounded-lg text-[10px] font-black transition-all ${localData.settings.showLightEffect ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-slate-400 border border-slate-200'}`}>{localData.settings.showLightEffect ? 'เปิดเอฟเฟกต์แสง' : 'ปิดเอฟเฟกต์'}</button>
                                                </div>
                                            </div>
                                            <div className="space-y-1.5">
                                                <label className="text-[10px] font-black text-blue-500 uppercase tracking-widest ml-1 flex justify-between items-center"><span>Brightness</span><span className="text-blue-600">{localData.settings.lightBrightness || 70}%</span></label>
                                                <input type="range" min="0" max="100" value={localData.settings.lightBrightness || 70} onChange={(e) => handleLightUpdate('lightBrightness', parseInt(e.target.value))} className="w-full h-1.5 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600"/>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="flex items-center gap-4 bg-white p-4 rounded-2xl shadow-md border-2 border-slate-100 sticky top-0 z-40">
                                <div className="flex items-center gap-2 text-slate-500 font-bold uppercase text-xs tracking-wider border-r pr-4 mr-2"><UsersIcon size={18}/><span>เลือกพื้นที่กรอกคะแนน</span></div>
                                <div className="flex gap-2 flex-1 overflow-x-auto pb-1">
                                    <button onClick={() => setAdminFilter('all')} className={`px-4 py-2 rounded-xl text-xs font-black transition-all whitespace-nowrap ${adminFilter === 'all' ? 'bg-slate-800 text-white shadow-lg scale-105' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}>ดูทั้งหมด (1-10)</button>
                                    <button onClick={() => setAdminFilter('1-5')} className={`px-4 py-2 rounded-xl text-xs font-black transition-all whitespace-nowrap flex items-center gap-2 ${adminFilter === '1-5' ? 'bg-blue-600 text-white shadow-lg scale-105' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}><span className="w-2 h-2 rounded-full bg-current opacity-50"></span>เขต 1 - 5 (ชุดที่ 1)</button>
                                    <button onClick={() => setAdminFilter('6-10')} className={`px-4 py-2 rounded-xl text-xs font-black transition-all whitespace-nowrap flex items-center gap-2 ${adminFilter === '6-10' ? 'bg-indigo-600 text-white shadow-lg scale-105' : 'bg-slate-100 text-slate-500 hover:bg-slate-200'}`}><span className="w-2 h-2 rounded-full bg-current opacity-50"></span>เขต 6 - 10 (ชุดที่ 2)</button>
                                </div>
                            </div>

                            <div className="space-y-10 pb-60">
                                {localData.districts.filter(d => { if (adminFilter === '1-5') return d.id >= 1 && d.id <= 5; if (adminFilter === '6-10') return d.id >= 6 && d.id <= 10; return true; }).map((d) => (
                                    <div key={d.id} className="bg-white rounded-3xl border-2 shadow-md overflow-hidden border-slate-200 animate-[slideIn_0.3s_ease-out]">
                                        <div className="bg-slate-100/50 px-8 py-4 border-b-2 flex justify-between items-center flex-wrap gap-2">
                                            <div className="flex items-center gap-4"><h3 className="font-black text-2xl text-slate-700 tracking-tighter uppercase">{d.name}</h3><span className={`text-[10px] font-black border-2 px-3 py-1 rounded-full tracking-widest uppercase ${d.lastUpdated ? 'bg-green-100 text-green-600 border-green-200' : 'bg-slate-100 text-slate-400 border-slate-200'}`}>Sync: {d.lastUpdated || 'No Data'}</span></div>
                                            <button onClick={() => saveData(d.id)} className="bg-green-600 text-white px-8 py-2.5 rounded-xl text-sm font-black uppercase shadow-xl active:scale-95 hover:bg-green-700 transition-colors">บันทึกคะแนน {d.name}</button>
                                        </div>
                                        <div className="p-6 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 bg-slate-50/30">
                                            {d.candidates.map((c, idx) => (
                                                <div key={idx} className="flex items-center gap-3 border p-3 rounded-xl bg-white hover:border-blue-400 transition-all shadow-sm">
                                                    <div className="flex flex-col gap-1 shrink-0">
                                                        <button onClick={() => handleMove(d.id, idx, -1)} disabled={idx === 0} className="p-1 text-slate-300 hover:text-blue-500 disabled:opacity-30"><ArrowUpIcon size={14}/></button>
                                                        <button onClick={() => handleMove(d.id, idx, 1)} disabled={idx === d.candidates.length - 1} className="p-1 text-slate-300 hover:text-blue-500 disabled:opacity-30"><ArrowDownIcon size={14}/></button>
                                                    </div>
                                                    <div onClick={() => setImageModalData({ districtId: d.id, candidateNo: c.no, initialUrl: c.image })} className="relative shrink-0 w-12 h-16 rounded-lg bg-slate-50 border cursor-pointer overflow-hidden group shadow-inner">
                                                        <img src={c.image || `https://placehold.co/100x133/${localData.partyColors[c.party]?.replace('#','') || '64748b'}/FFFFFF?text=${c.no}`} className="w-full h-full object-cover"/>
                                                        <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity backdrop-blur-[1px]"><CameraIcon size={20} className="text-white drop-shadow-md"/></div>
                                                    </div>
                                                    <div className="flex-1 flex flex-col min-w-0 pr-2">
                                                        <div className="flex items-center gap-2">
                                                            <input type="text" value={c.no} onChange={(e)=>handleCandidateInfoChange(d.id, c.no, 'no', e.target.value)} className="w-7 text-[11px] font-black border-b border-slate-200 outline-none text-center bg-slate-50 rounded" title="เบอร์"/>
                                                            <input type="text" value={c.name} onChange={(e)=>handleCandidateInfoChange(d.id, c.no, 'name', e.target.value)} className="flex-1 text-sm font-bold border-b border-transparent outline-none truncate" placeholder="ชื่อ ส.ส."/>
                                                        </div>
                                                        <input type="text" value={c.party} onChange={(e)=>handleCandidateInfoChange(d.id, c.no, 'party', e.target.value)} className="w-full text-xs text-slate-400 border-b border-transparent outline-none mt-1 truncate" placeholder="พรรค"/>
                                                    </div>
                                                    <div className="shrink-0 flex flex-col items-center">
                                                        <span className="text-[9px] font-bold text-slate-300 mb-0.5 uppercase">Score</span>
                                                        <input id={`score-${d.id}-${idx}`} type="tel" pattern="[0-9]*" value={c.score.toString()} onKeyDown={(e)=>{ if(e.key==='Enter'){ e.preventDefault(); const next=document.getElementById(`score-${d.id}-${idx+1}`); if(next){next.focus(); next.select();} } }} onChange={(e)=>handleScoreChange(d.id, c.no, e.target.value)} onFocus={(e)=>e.target.select()} className="w-20 text-right border-2 border-slate-100 rounded-lg px-2 py-1.5 font-black text-xl text-blue-700 focus:border-blue-400 outline-none shadow-inner bg-slate-50 focus:bg-white"/>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                    {saveTriggered && <div className="fixed bottom-10 right-10 z-[100] bg-green-600 text-white px-8 py-4 rounded-3xl shadow-2xl flex items-center gap-4 save-status-pop border-4 border-white/20"><CheckIcon size={24}/><span className="font-black text-xl uppercase tracking-widest">Saved & Synced</span></div>}
                </div>
            );
        }

        // --- Core Application ---
        function App() {
            const urlParams = new URLSearchParams(window.location.search);
            const isOnlineMode = !!configToUse;
            const [mode, setMode] = useState(urlParams.get('mode') === 'admin' ? 'admin' : 'viewer');
            const [data, setData] = useState(null);
            const [localData, setLocalData] = useState(null);
            const [user, setUser] = useState(null);
            const [slideIndex, setSlideIndex] = useState(0);
            const [saveTriggered, setSaveTriggered] = useState(false);
            const [setupError, setSetupError] = useState(null);

            useEffect(() => {
                const loadInitialData = () => {
                    const saved = localStorage.getItem('electionData');
                    const initial = saved ? JSON.parse(saved) : INITIAL_DATA;
                    if (initial.settings) {
                        if (!initial.settings.enabledSlides) initial.settings.enabledSlides = ALL_SLIDES;
                        if (initial.settings.showLightEffect === undefined) initial.settings.showLightEffect = true;
                        if (initial.settings.lightBrightness === undefined) initial.settings.lightBrightness = 70;
                    }
                    setData(initial); setLocalData(JSON.parse(JSON.stringify(initial))); 
                };

                if (!isOnlineMode) {
                    loadInitialData();
                    const onStorageChange = (e) => { if (e.key === 'electionData' || e.type === 'storage') { const updated = JSON.parse(localStorage.getItem('electionData')); if (updated) { setData(updated); if (mode !== 'admin') setLocalData(updated); } } };
                    window.addEventListener('storage', onStorageChange); return () => window.removeEventListener('storage', onStorageChange);
                } else {
                    const initAuth = async () => {
                        try {
                            if (isInternalEnv && typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await auth.signInWithCustomToken(__initial_auth_token); else await auth.signInAnonymously();
                        } catch (e) {
                            console.error("Auth Error", e);
                            if (e.code === 'auth/configuration-not-found' || e.code === 'auth/operation-not-allowed' || e.code === 'auth/admin-restricted-operation') setSetupError("⚠️ ตั้งค่าไม่ครบ! กรุณาเปิดใช้งาน Anonymous Auth ใน Firebase Console ก่อน (เมนู Build > Authentication > Sign-in method > Anonymous -> Enable)");
                            loadInitialData();
                        }
                    };
                    initAuth();
                    const unsubscribe = auth.onAuthStateChanged((u) => { setUser(u); if (u) setSetupError(null); else loadInitialData(); });
                    return () => unsubscribe();
                }
            }, [isOnlineMode]);

            useEffect(() => {
                if (isOnlineMode && user) {
                    const docRef = getDocRef(); if (!docRef) return;
                    const unsubscribe = docRef.onSnapshot((doc) => {
                        if (doc.exists) {
                            const cloudData = doc.data();
                            if (cloudData.settings) {
                                if (cloudData.settings.showLightEffect === undefined) cloudData.settings.showLightEffect = true;
                                if (cloudData.settings.lightBrightness === undefined) cloudData.settings.lightBrightness = 70;
                            }
                            setData(cloudData); if (mode !== 'admin' || !localData) setLocalData(cloudData);
                        } else docRef.set(INITIAL_DATA);
                    }, (error) => console.error("Firestore Sync Error:", error));
                    return () => unsubscribe();
                }
            }, [isOnlineMode, user, mode]);

            useEffect(() => {
                if (mode === 'viewer' && data) {
                    if (data.settings.displayMode === 'fixed') setSlideIndex(parseInt(data.settings.activeSlide));
                    else { 
                        const enabled = data.settings.enabledSlides || ALL_SLIDES;
                        if (!enabled.includes(slideIndex)) setSlideIndex(enabled[0] || 0);
                        const interval = setInterval(() => {
                            setSlideIndex((current) => {
                                if (enabled.length === 0) return current;
                                const currentIndexInPlaylist = enabled.indexOf(current);
                                const nextIndexInPlaylist = (currentIndexInPlaylist + 1) % enabled.length;
                                return enabled[nextIndexInPlaylist];
                            });
                        }, (data.settings.cycleTime || 10) * 1000); 
                        return () => clearInterval(interval); 
                    }
                }
            }, [mode, data?.settings?.displayMode, data?.settings?.activeSlide, data?.settings?.cycleTime, data?.settings?.enabledSlides]);

            const handleScoreChange = (distId, cNo, val) => { const score = val === '' ? 0 : parseInt(val); setLocalData(p => ({...p, districts: p.districts.map(d => d.id === distId ? {...d, candidates: d.candidates.map(c => c.no === cNo ? {...c, score: isNaN(score) ? c.score : score} : c)} : d)})); };
            const handleCandidateInfoChange = (distId, cNo, field, val) => { setLocalData(p => ({...p, districts: p.districts.map(d => d.id === distId ? {...d, candidates: d.candidates.map(c => c.no === cNo ? {...c, [field]: val} : c)} : d)})); };
            const handleSettingChange = (field, val) => { setLocalData(p => ({...p, settings: {...p.settings, [field]: val}})); };
            const handleImageChange = (distId, cNo, url) => { setLocalData(p => ({...p, districts: p.districts.map(d => d.id === distId ? {...d, candidates: d.candidates.map(c => c.no === cNo ? {...c, image: url} : c)} : d)})); };
            const handleBgUpload = (file) => {
                if(!file) return; const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                        const scale = Math.min(1, 1920 / img.width); canvas.width = img.width * scale; canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height); handleSettingChange('backgroundImage', canvas.toDataURL('image/jpeg', 0.85));
                    };
                };
                reader.readAsDataURL(file);
            };

            const saveData = async (distId = null) => {
                if (!localData) return; 
                let toSave = { ...localData };
                if (distId) { 
                    const now = new Date(); const timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`; 
                    toSave.districts = toSave.districts.map(d => d.id === distId ? {...d, lastUpdated: timeStr} : d); 
                    setLocalData(toSave);
                }
                try {
                    if (isOnlineMode) { const docRef = getDocRef(); if(docRef) await docRef.set(toSave); } 
                    else { localStorage.setItem('electionData', JSON.stringify(toSave)); setData(toSave); window.dispatchEvent(new Event('storage')); }
                    setSaveTriggered(true); setTimeout(() => setSaveTriggered(false), 2000);
                } catch(e) { console.error(e); alert("Save Failed"); }
            };

            if (!data) return <div className="h-screen w-screen bg-slate-900 flex items-center justify-center text-white flex-col gap-4"><div className="loader"></div><div>กำลังเชื่อมต่อระบบเลือกตั้ง...</div></div>;
            
            if (mode === 'admin') return <AdminPanel localData={localData} setLocalData={setLocalData} handleScoreChange={handleScoreChange} handleSettingChange={handleSettingChange} saveData={saveData} handleCandidateInfoChange={handleCandidateInfoChange} handleImageChange={handleImageChange} isOnlineMode={isOnlineMode} saveTriggered={saveTriggered} handleBgUpload={handleBgUpload} setMode={setMode} setupError={setupError} />;

            return (
                <div className="dashboard-container relative select-none">
                    <div className="bg-animated-container">
                        {data.settings.backgroundImage && <div className="absolute inset-0 bg-cover bg-center transition-opacity duration-1000" style={{backgroundImage: `url(${data.settings.backgroundImage})`}}></div>}
                        {data.settings.showLightEffect && <div style={{ opacity: (data.settings.lightBrightness || 70) / 100 }} className="transition-opacity duration-500"><div className="beam beam-1"></div><div className="beam beam-2"></div><div className="beam beam-3"></div></div>}
                        <div className="absolute inset-0 bg-black/40 shadow-[inner_0_0_100px_rgba(0,0,0,0.5)]"></div>
                    </div>
                    
                    <header className="glass-panel flex justify-between items-center px-8 z-20 cursor-default">
                        <h1 className="text-2xl font-bold text-white thai-text drop-shadow-md uppercase truncate max-w-[70%]">{data.settings.title}</h1>
                        <Clock onClick={() => setMode('admin')} />
                    </header>
                    <main className="overflow-hidden relative" key={slideIndex}>
                        {slideIndex < 10 ? <DistrictView district={data.districts[slideIndex]} partyColors={data.partyColors || DEFAULT_PARTY_COLORS} /> : <SummaryView data={data} partyColors={data.partyColors || DEFAULT_PARTY_COLORS} />}
                    </main>
                    <footer className="bg-blue-900/90 backdrop-blur-md text-white flex items-center overflow-hidden z-20 border-t-2 border-blue-500 h-10 cursor-default">
                        <div className="bg-red-600 h-full px-6 flex items-center font-bold text-xl shrink-0 z-10 text-white thai-text shadow-lg uppercase">หมายเหตุ</div>
                        <div className="whitespace-nowrap overflow-hidden flex-1 relative h-full flex items-center">
                            <div className="absolute left-0 w-full text-xl font-medium thai-text" style={{ animation: `marquee ${data.settings.marqueeSpeed || 20}s linear infinite` }}>{data.settings.footer}</div>
                        </div>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
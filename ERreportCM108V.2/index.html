<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà (Secure v10.9 Final + Area Fix + NewTab)</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700;800&family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Prompt', sans-serif; overflow: hidden; background-color: #020617; }
        
        /* ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î Live Viewer */
        .live-viewer { cursor: none; }
        
        .bg-animated-container { 
            background: #020617;
            position: absolute;
            inset: 0;
            overflow: hidden;
            z-index: -1;
        }

        .beam {
            position: absolute;
            width: 200vw;
            height: 40vh;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(30, 64, 175, 0.3) 25%, 
                rgba(59, 130, 246, 0.7) 50%, 
                rgba(30, 64, 175, 0.3) 75%, 
                transparent 100%
            );
            transform: rotate(-25deg);
            filter: blur(80px);
            pointer-events: none;
            z-index: 5;
            mix-blend-mode: screen;
        }

        .beam-1 { top: -20%; left: -50%; animation: sweep 12s infinite ease-in-out; }
        .beam-2 { top: 25%; left: -60%; animation: sweep 18s infinite ease-in-out reverse; }
        .beam-3 { top: 70%; left: -40%; animation: sweep 15s infinite ease-in-out; }

        @keyframes sweep {
            0% { transform: translate(-15%, -5%) rotate(-25deg); }
            50% { transform: translate(15%, 5%) rotate(-25deg); }
            100% { transform: translate(-15%, -5%) rotate(-25deg); }
        }
        
        .glass-panel { 
            background: rgba(2, 6, 23, 0.7); 
            backdrop-filter: blur(25px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.6); 
        }
        
        .page-transition { animation: slideInPage 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideInPage { 
            from { transform: scale(0.98); opacity: 0; filter: blur(10px); } 
            to { transform: scale(1); opacity: 1; filter: blur(0); } 
        }
        
        .score-pop { animation: popScale 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popScale {
            0% { transform: scale(1); color: #fff; }
            50% { transform: scale(1.08); color: #fbbf24; }
            100% { transform: scale(1); color: #fff; }
        }

        .candidate-card-enter { animation: slideIn 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
        @keyframes slideIn { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .admin-scroll::-webkit-scrollbar { width: 10px; }
        .admin-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .admin-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 5px; }
        
        .dashboard-container { 
            display: grid; 
            grid-template-rows: 80px 1fr 45px; 
            height: 100vh; 
            width: 100vw; 
            position: relative; 
            overflow: hidden; 
        }
        
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .text-shadow { text-shadow: 2px 2px 4px rgba(0,0,0,0.9); }
        .thai-text { line-height: 1.6 !important; padding-top: 4px; padding-bottom: 4px; display: block; }
        .img-fit { width: 100%; height: 100%; object-fit: cover; object-position: top; }
        
        .save-status-pop { animation: popOut 2s ease-out forwards; }
        @keyframes popOut { 0% { opacity: 0; transform: translateY(10px); } 20% { opacity: 1; transform: translateY(0); } 80% { opacity: 1; } 100% { opacity: 0; } }
        
        /* Fixed Marquee Animation */
        @keyframes marquee { 
            0% { transform: translateX(100vw); } 
            100% { transform: translateX(-100%); } 
        }

        @media (max-width: 768px) {
            .dashboard-container { grid-template-rows: 60px 1fr 30px; }
            h2 { font-size: 1.5rem !important; }
            .score-main { font-size: 2rem !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Firebase Config ---
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyC4xL7-ooqRwL8837vjn_X5fnrFfbYyrAc",
            authDomain: "election-results-report-cm108.firebaseapp.com",
            projectId: "election-results-report-cm108",
            storageBucket: "election-results-report-cm108.firebasestorage.app",
            messagingSenderId: "793102348089",
            appId: "1:793102348089:web:35c0a022e5dbf960f042e8",
            measurementId: "G-07QVSX6VLR"
        };

        let app, auth, db;
        if (!firebase.apps.length) app = firebase.initializeApp(USER_FIREBASE_CONFIG); 
        else app = firebase.app();
        auth = firebase.auth();
        db = firebase.firestore();

        const getDocRef = () => db.collection('election_data').doc('chiangmai_live');

        // --- Helper Functions ---
        const normalizeHex = (color) => {
            if (!color) return "#64748b";
            let c = color.trim();
            if (!c.startsWith('#')) return "#64748b";
            if (c.length === 4) c = "#" + c[1] + c[1] + c[2] + c[2] + c[3] + c[3];
            return (c.length === 7) ? c : "#64748b";
        };

        const getContrastColor = (hex) => {
            if (!hex) return 'text-white';
            const cleanHex = normalizeHex(hex);
            const r = parseInt(cleanHex.slice(1, 3), 16);
            const g = parseInt(cleanHex.slice(3, 5), 16);
            const b = parseInt(cleanHex.slice(5, 7), 16);
            if (isNaN(r) || isNaN(g) || isNaN(b)) return 'text-white';
            const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
            return (yiq >= 150) ? 'text-slate-900' : 'text-white';
        };

        // --- Constants ---
        const ALL_SLIDES = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
        const DEFAULT_PARTY_COLORS = { "‡∏ß‡∏¥‡∏ä‡∏ä‡∏±‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà": "#14b8a6", "‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô": "#ff7f00", "‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à": "#f59e0b", "‡∏Å‡∏•‡πâ‡∏≤‡∏ò‡∏£‡∏£‡∏°": "#8b5cf6", "‡∏†‡∏π‡∏°‡∏¥‡πÉ‡∏à‡πÑ‡∏ó‡∏¢": "#1e40af", "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢": "#dc2626", "‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ò‡∏¥‡∏õ‡∏±‡∏ï‡∏¢‡πå": "#3b82f6", "‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡πÉ‡∏´‡∏°‡πà": "#10b981", "‡∏£‡∏ß‡∏°‡πÑ‡∏ó‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏≤‡∏ï‡∏¥": "#2563eb", "‡πÑ‡∏ó‡∏¢‡∏Å‡πâ‡∏≤‡∏ß‡πÉ‡∏´‡∏°‡πà": "#6366f1", "‡∏£‡∏±‡∏Å‡∏ä‡∏≤‡∏ï‡∏¥": "#be123c", "‡πÄ‡∏™‡∏£‡∏µ‡∏£‡∏ß‡∏°‡πÑ‡∏ó‡∏¢": "#eab308", "‡∏Å‡πâ‡∏≤‡∏ß‡∏≠‡∏¥‡∏™‡∏£‡∏∞": "#64748b", "‡∏û‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏£‡∏±‡∏ê": "#15803d", "‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£‡πÑ‡∏ó‡∏¢": "#ec4899", "‡∏õ‡∏ß‡∏á‡∏ä‡∏ô‡πÑ‡∏ó‡∏¢": "#a855f7", "‡∏û‡∏•‡∏ß‡∏±‡∏ï": "#06b6d4", "‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ö‡πâ‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á": "#f97316" };
        const INITIAL_DATA = { settings: { title: "‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á ‡∏™.‡∏™. ‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà 10 ‡πÄ‡∏Ç‡∏ï (‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£)", footer: "‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏ú‡∏•‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£", cycleTime: 10, marqueeSpeed: 20, marqueeDelay: 3, backgroundImage: "", displayMode: 'auto', activeSlide: 0, enabledSlides: ALL_SLIDES, showLightEffect: true, lightBrightness: 70, showPercentage: true }, partyColors: DEFAULT_PARTY_COLORS, districts: Array.from({length: 10}, (_, i) => ({ id: i + 1, name: `‡πÄ‡∏Ç‡∏ï ${i + 1}`, area: "", lastUpdated: null, progress: 0, candidates: Array.from({length: 12}, (_, j) => ({ no: j + 1, name: `‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà ${j + 1}`, party: Object.keys(DEFAULT_PARTY_COLORS)[j % Object.keys(DEFAULT_PARTY_COLORS).length], score: 0 })) })) };

        // --- Icons ---
        function Icon({ children, size = 24, className = "" }) { return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>; }
        function SaveIcon(p) { return <Icon {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>; }
        function MonitorIcon(p) { return <Icon {...p}><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></Icon>; }
        function CameraIcon(p) { return <Icon {...p}><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1-2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></Icon>; }
        function ArrowUpIcon(p) { return <Icon {...p}><polyline points="18 15 12 9 6 15"/></Icon>; }
        function ArrowDownIcon(p) { return <Icon {...p}><polyline points="6 9 12 15 18 9"/></Icon>; }
        function CheckIcon(p) { return <Icon {...p}><polyline points="20 6 9 17 4 12"/></Icon>; }
        function LoaderIcon(p) { return <Icon {...p} className={`animate-spin ${p.className}`}><path d="M12 2v4m0 12v4M4.93 4.93l2.83 2.83m8.48 8.48l2.83 2.83M2 12h4m12 0h4M4.93 19.07l2.83-2.83m8.48-8.48l2.83-2.83"/></Icon>; }
        function LockIcon(p) { return <Icon {...p}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></Icon>; }
        function LogoutIcon(p) { return <Icon {...p}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></Icon>; }
        function PaletteIcon(p) { return <Icon {...p}><circle cx="13.5" cy="6.5" r=".5"></circle><circle cx="17.5" cy="10.5" r=".5"></circle><circle cx="8.5" cy="7.5" r=".5"></circle><circle cx="6.5" cy="12.5" r=".5"></circle><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.926 0 1.648-.746 1.648-1.688 0-.437-.18-.835-.437-1.125-.29-.289-.438-.652-.438-1.125a1.64 1.64 0 0 1 1.668-1.668h1.996c3.051 0 5.555-2.503 5.555-5.554C21.965 6.012 17.461 2 12 2z"></path></Icon>; }
        function UsersIcon(p) { return <Icon {...p}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></Icon>; }
        function SettingsIcon(p) { return <Icon {...p}><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></Icon>; }
        function ImageIconAdmin(p) { return <Icon {...p}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></Icon>; }
        function GlobeIcon(p) { return <Icon {...p}><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></Icon>; }
        function PercentIcon(p) { return <Icon {...p}><line x1="19" y1="5" x2="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></Icon>; }
        function ClockIcon(p) { return <Icon {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>; }
        function DatabaseIcon(p) { return <Icon {...p}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></Icon>; }
        function DownloadIcon(p) { return <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></Icon>; }
        function UploadIcon(p) { return <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></Icon>; }
        function PlusIcon(p) { return <Icon {...p}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></Icon>; }
        function TrashIcon(p) { return <Icon {...p}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></Icon>; }
        function RotateCcwIcon(p) { return <Icon {...p}><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></Icon>; }

        // --- Shared UI Components ---
        function Clock({ onClick }) {
            const [time, setTime] = useState(new Date());
            useEffect(() => { const timer = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(timer); }, []);
            return (
                <div className="text-right cursor-pointer group select-none pointer-events-auto relative z-50 flex items-center gap-4" onClick={onClick}>
                    <div className="hidden group-hover:block text-xs bg-white text-blue-900 px-2 py-1 rounded font-bold uppercase animate-pulse shadow-xl">Admin Panel</div>
                    <div>
                        <div className="text-3xl font-mono font-bold text-white leading-none group-hover:text-blue-400 transition-colors">
                            {time.toLocaleTimeString('th-TH', {hour: '2-digit', minute:'2-digit'})}
                        </div>
                        <div className="text-sm text-blue-200 mt-1">
                            {time.toLocaleDateString('th-TH', {day:'numeric', month:'long', year:'numeric'})}
                        </div>
                    </div>
                </div>
            );
        }

        function LoginScreen() {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);
            const handleLogin = async (e) => {
                e.preventDefault(); setLoading(true); setError('');
                try { await auth.signInWithEmailAndPassword(email, password); } 
                catch (err) { setError('‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì'); setLoading(false); }
            };
            return (
                <div className="h-screen flex items-center justify-center bg-slate-900 p-4 relative overflow-hidden">
                    <div className="beam beam-1 opacity-20"></div>
                    <div className="bg-white/10 backdrop-blur-xl rounded-3xl shadow-2xl p-8 w-full max-sm:w-full border border-white/20 relative z-10">
                        <div className="text-center mb-8"><div className="w-20 h-20 bg-blue-500/20 text-blue-400 rounded-full flex items-center justify-center mx-auto mb-4 border border-blue-500/30"><LockIcon size={40}/></div><h2 className="text-2xl font-bold text-white uppercase tracking-wider">Admin Login</h2><p className="text-blue-200/60 text-sm mt-1 leading-none">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ï‡∏±‡πâ‡∏á</p></div>
                        <form onSubmit={handleLogin} className="space-y-5">
                            <div><label className="block text-xs font-bold text-blue-300 uppercase mb-2 ml-1">Email</label><input type="email" value={email} onChange={e=>setEmail(e.target.value)} required className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-blue-500 outline-none transition-all placeholder:text-white/20" placeholder="admin@example.com"/></div>
                            <div><label className="block text-xs font-bold text-blue-300 uppercase mb-2 ml-1">Password</label><input type="password" value={password} onChange={e=>setPassword(e.target.value)} required className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white focus:border-blue-500 outline-none transition-all placeholder:text-white/20" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/></div>
                            {error && <div className="text-red-400 text-xs font-bold text-center bg-red-500/10 p-3 rounded-xl border border-red-500/20">{error}</div>}
                            <button type="submit" disabled={loading} className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-2xl active:scale-95 transition-all flex justify-center items-center gap-2">{loading ? <LoaderIcon size={20}/> : '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö'}</button>
                        </form>
                    </div>
                </div>
            );
        }

        // --- Modals ---
        function ImageUploadModal({ isOpen, onClose, onSave, districtId, candidateNo, initialUrl }) {
            const [mode, setMode] = useState('url'); const [tempUrl, setTempUrl] = useState(initialUrl || ''); const fileInputRef = useRef(null);
            useEffect(() => { setTempUrl(initialUrl || ''); setMode('url'); }, [initialUrl, isOpen]);
            if (!isOpen) return null;
            const handleFileChange = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader(); reader.onload = (event) => {
                    const img = new Image(); img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                        const scale = Math.min(1, 400 / img.width); canvas.width = img.width * scale; canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height); setTempUrl(canvas.toDataURL('image/jpeg', 0.8)); setMode('upload');
                    }
                }; reader.readAsDataURL(file);
            };
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-[fadeIn_0.2s]">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="bg-slate-100 px-6 py-4 border-b flex justify-between items-center"><h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><ImageIconAdmin size={20} className="text-blue-600"/> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</h3><button onClick={onClose} className="text-slate-400 hover:text-red-500 transition-colors"><Icon size={24}><path d="M18 6L6 18M6 6l12 12"/></Icon></button></div>
                        <div className="p-6 flex-1 overflow-y-auto">
                            <div className="flex justify-center mb-6"><div className="w-32 h-44 bg-slate-200 rounded-lg shadow-inner border-2 border-white ring-2 ring-slate-100 overflow-hidden relative group">{tempUrl ? <img src={tempUrl} className="w-full h-full object-cover bg-white" /> : <div className="flex flex-col items-center justify-center h-full text-slate-400"><ImageIconAdmin size={32} className="opacity-20 mb-2"/><span className="text-xs font-bold">No Image</span></div>}</div></div>
                            <div className="flex bg-slate-100 p-1 rounded-xl mb-6"><button onClick={() => setMode('url')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${mode === 'url' ? 'bg-white shadow text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}><span className="flex items-center justify-center gap-2"><GlobeIcon size={14}/> URL</span></button><button onClick={() => setMode('upload')} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${mode === 'upload' ? 'bg-white shadow text-blue-600' : 'text-slate-500 hover:text-slate-700'}`}><span className="flex items-center justify-center gap-2"><CameraIcon size={14}/> Upload</span></button></div>
                            {mode === 'url' ? <input type="text" value={tempUrl.startsWith('data:') ? '' : tempUrl} onChange={(e) => setTempUrl(e.target.value)} placeholder="https://..." className="w-full border-2 border-slate-200 rounded-xl px-4 py-3 text-sm outline-none focus:border-blue-500 transition-all"/> : <div className="text-center py-8 border-2 border-dashed border-slate-300 rounded-xl hover:border-blue-500 hover:bg-blue-50 cursor-pointer bg-slate-50 group" onClick={() => fileInputRef.current.click()}><div className="mx-auto w-14 h-14 bg-white shadow-sm border text-blue-500 rounded-full flex items-center justify-center mb-3 transition-transform group-hover:scale-110"><CameraIcon size={24}/></div><div className="text-sm font-bold text-slate-600">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</div><input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={handleFileChange}/></div>}
                        </div>
                        <div className="p-4 bg-slate-50 border-t flex gap-3"><button onClick={onClose} className="flex-1 py-3 text-sm font-bold text-slate-500 hover:bg-slate-200 rounded-xl transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button onClick={() => onSave(districtId, candidateNo, tempUrl)} className="flex-[2] py-3 text-sm font-bold bg-blue-600 text-white hover:bg-blue-700 rounded-xl shadow-lg active:scale-95 transition-all flex items-center justify-center gap-2"><SaveIcon size={18}/> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
                    </div>
                </div>
            );
        }

        function PartyColorModal({ isOpen, onClose, currentColors, onUpdate }) {
            const [colors, setColors] = useState(currentColors || {}); const [newPartyName, setNewPartyName] = useState(""); const [newPartyColor, setNewPartyColor] = useState("#000000");
            useEffect(() => { setColors(currentColors || {}); }, [currentColors, isOpen]);
            if (!isOpen) return null;
            const handleSave = () => { onUpdate(colors); onClose(); };
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-[fadeIn_0.2s]">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[85vh]">
                        <div className="bg-slate-100 px-6 py-4 border-b flex justify-between items-center"><h3 className="font-bold text-lg text-slate-800 flex items-center gap-2"><PaletteIcon size={20} className="text-pink-600"/> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏µ‡∏û‡∏£‡∏£‡∏Ñ</h3><button onClick={onClose} className="text-slate-400 hover:text-red-500 transition-colors"><Icon size={24}><path d="M18 6L6 18M6 6l12 12"/></Icon></button></div>
                        <div className="p-6 overflow-y-auto flex-1">
                            <div className="flex gap-2 mb-6 bg-slate-50 p-4 rounded-xl border items-center"><input type="text" value={newPartyName} onChange={e => setNewPartyName(e.target.value)} placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏£‡∏£‡∏Ñ‡πÉ‡∏´‡∏°‡πà..." className="flex-1 px-3 py-2 rounded-lg border outline-none text-sm" /><div className="flex items-center gap-1 border rounded bg-white px-2 py-1"><input type="color" value={newPartyColor} onChange={e => setNewPartyColor(e.target.value)} className="w-6 h-6 cursor-pointer" /><input type="text" value={newPartyColor} onChange={e => setNewPartyColor(e.target.value)} className="w-16 text-xs outline-none" maxLength={7} /></div><button onClick={() => { if (newPartyName.trim()) { setColors({...colors, [newPartyName.trim()]: newPartyColor}); setNewPartyName(""); } }} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-md">‡πÄ‡∏û‡∏¥‡πà‡∏°</button></div>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">{Object.entries(colors).map(([party, color]) => (<div key={party} className="flex items-center gap-3 p-2 border rounded-lg hover:border-blue-400 bg-white shadow-sm"><div className="flex items-center gap-1 border rounded bg-slate-50 px-1.5 py-1 shrink-0"><input type="color" value={color} onChange={(e) => setColors({...colors, [party]: e.target.value})} className="w-5 h-5" /><input type="text" value={color} onChange={(e) => setColors({...colors, [party]: e.target.value})} className="w-14 text-[10px] font-mono outline-none bg-transparent" maxLength={7} /></div><span className="flex-1 font-medium text-sm truncate">{party}</span><button onClick={() => { if(confirm(`‡∏•‡∏ö ${party}?`)) { const n={...colors}; delete n[party]; setColors(n); } }} className="text-slate-300 hover:text-red-500 p-1"><Icon size={16}><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></Icon></button></div>))}</div>
                        </div>
                        <div className="p-4 border-t flex justify-end gap-3 bg-slate-50"><button onClick={onClose} className="px-4 py-2 rounded-lg text-slate-600 font-bold hover:bg-slate-200 transition-colors">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button><button onClick={handleSave} className="px-6 py-2 rounded-lg bg-pink-600 text-white font-bold shadow-lg hover:bg-pink-700 active:scale-95 transition-all flex items-center justify-center gap-2"><SaveIcon size={16}/> ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>
                    </div>
                </div>
            );
        }

        // --- Core Views (GOOD LOGIN LAYOUT PRESERVED) ---
        function DistrictView({ district, partyColors, showPercentage }) {
            if (!district) return null; const sorted = [...district.candidates].sort((a, b) => b.score - a.score); const getColor = (p) => normalizeHex(partyColors[p] || "#64748b"); const top3 = [sorted[0], sorted[1], sorted[2]];
            return (
                <div className="flex-1 px-8 py-4 relative h-full flex flex-col pt-8 page-transition">
                    <div className="flex justify-between items-end mb-4 z-10 relative h-auto shrink-0 -mt-8">
                        <div>
                            <h2 className="text-[3.1rem] font-bold text-white drop-shadow-md flex items-center text-shadow thai-text uppercase">
                                <span className="px-4 py-1.5 rounded-lg mr-4 text-[1.9rem] shadow-lg text-white" style={{backgroundColor: getColor(sorted[0]?.party)}}>‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà</span>
                                {district.name}
                                {/* ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≥‡πÄ‡∏†‡∏≠: ‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á ‡∏ï‡∏±‡∏ß‡∏ö‡∏≤‡∏á ‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á () ‡πÅ‡∏•‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏à‡∏≠ | */}
                                {district.area && (
                                    <span className="ml-3 text-[0.85rem] font-light text-blue-100 opacity-90 leading-tight whitespace-pre-line shadow-none tracking-normal" style={{maxWidth: '400px', display: 'inline-block', verticalAlign: 'bottom', paddingBottom: '8px', textShadow: 'none'}}>
                                        {district.area.split('|').map((item, index, arr) => (
                                            <React.Fragment key={index}>
                                                {item}
                                                {index < arr.length - 1 && <br />}
                                            </React.Fragment>
                                        ))}
                                    </span>
                                )}
                            </h2>
                            <div className="text-blue-200 text-xl flex items-center mt-0.5 font-medium ml-1"><div className={`w-3.5 h-3.5 rounded-full mr-2 ${district.lastUpdated ? 'bg-green-500 animate-pulse' : 'bg-gray-500'}`}></div>‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: {district.lastUpdated || "‡∏£‡∏≠‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô"}</div>
                        </div>
                         {showPercentage && (
                            <div className="absolute left-1/2 -translate-x-1/2 bottom-0 mb-2 flex items-center gap-3 bg-black/40 px-6 py-2 rounded-2xl border border-white/5 backdrop-blur-sm shadow-xl">
                                <span className="text-white text-xl font-bold text-shadow thai-text">‡∏ô‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß</span>
                                <span className="bg-cyan-500 text-white px-4 py-0.5 rounded-xl text-[1.6rem] font-black shadow-[0_0_8px_rgba(6,182,212,0.3)] border border-cyan-300">
                                    {district.progress || 0}%
                                </span>
                            </div>
                        )}
                        <div className="text-right"><div className="text-blue-200 text-xl mb-1 font-bold uppercase tracking-widest text-shadow">‡∏ô‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß (‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)</div><div className="text-[3.2rem] font-bold text-white text-shadow tracking-widest score-pop leading-none">{district.candidates.reduce((a,b)=>a+b.score, 0).toLocaleString()}</div></div>
                    </div>
                    <div className="flex gap-6 mb-3 z-10 relative h-[42%] shrink-0 items-end">{top3.map((c, i) => { const is1 = i === 0; const color = getColor(c?.party); return (<div key={i} className={`${is1 ? 'flex-[1.6] h-[100%]' : 'flex-1 h-[90%]'} relative rounded-[1.25rem] p-4 flex flex-row items-center gap-4 shadow-2xl transition-all duration-500`} style={{background: `linear-gradient(135deg, ${color}cc, ${color}66)`, border: is1 ? '2.5px solid white' : '1px solid rgba(255,255,255,0.2)'}}><div className={`absolute -top-3.5 -right-3.5 ${is1 ? 'text-[1.6rem] w-14 h-14' : 'text-[1.4rem] w-12 h-12'} font-black rounded-full flex items-center justify-center shadow-lg border-2 bg-white text-blue-900 z-20`}>{i+1}</div><div className="h-full w-[40%] relative flex-shrink-0 flex items-center justify-center"><div className="h-full w-auto aspect-[3/4] rounded-xl border-2 border-white/30 overflow-hidden bg-slate-800 shadow-2xl relative"><img src={c?.image || `https://placehold.co/150x200/${color.replace('#','')}/FFFFFF?text=${c?.no}`} className="img-fit"/></div><div className="absolute -bottom-3 left-1/2 transform -translate-x-1/2 bg-white text-blue-900 font-bold px-3.5 py-1 rounded-full shadow-xl text-sm whitespace-nowrap">‡πÄ‡∏ö‡∏≠‡∏£‡πå {c?.no}</div></div><div className="flex-1 flex flex-col justify-center h-full min-w-0"><h3 className={`text-white font-semibold leading-tight thai-text ${is1 ? 'text-[1.9rem]' : 'text-[1.3rem]'}`}>{c?.name}</h3><div className="mt-2.5 mb-2.5"><span className={`font-bold px-3.5 py-1 rounded-full border border-white/20 bg-black/20 text-base ${getContrastColor(color)}`} style={{backgroundColor: color}}>{c?.party}</span></div><div className={`${is1 ? 'text-[3.8rem]' : 'text-[2.6rem]'} font-black text-white text-shadow score-pop leading-none`}>{c?.score.toLocaleString()}</div></div></div>); })}</div>
                    <div className="flex-1 relative grid grid-cols-4 gap-x-3 gap-y-2.5 content-start overflow-hidden pt-2 pb-2">{sorted.slice(3).map((c, idx) => (<div key={idx} className="flex items-center bg-gray-900/80 rounded-xl p-2 border border-white/10 h-[5.25rem] candidate-card-enter shadow-md"><div className="h-full aspect-[3/4] rounded-lg bg-gray-700 mr-2 shrink-0 overflow-hidden border relative flex justify-center items-center" style={{borderColor: getColor(c.party)}}><img src={c.image || `https://placehold.co/150x200/${getColor(c.party).replace('#','')}/FFFFFF?text=${c.no}`} className="img-fit"/></div><div className="flex-1 min-w-0 mr-1 flex flex-col justify-center h-full overflow-visible"><div className="text-white text-[17.4px] font-semibold truncate text-shadow thai-text leading-normal py-0.5">{c.name}</div><div className="mt-1 flex items-center gap-1.5"><span className={`text-[13.3px] font-medium px-3 py-0.5 rounded-full border shadow-sm ${getContrastColor(getColor(c.party))}`} style={{backgroundColor: getColor(c.party)}}>{c.party}</span><span className="bg-white text-blue-900 text-[13.3px] px-3 py-0.5 rounded-full font-bold shadow-md border border-white">‡πÄ‡∏ö‡∏≠‡∏£‡πå {c.no}</span></div></div><div className="text-[1.6rem] font-bold text-white w-20 text-right text-shadow score-pop">{c.score.toLocaleString()}</div></div>))}</div>
                </div>
            );
        }

        function SummaryView({ data, partyColors }) {
            if (!data) return null; const getColor = (p) => normalizeHex(partyColors[p] || "#64748b"); const winners = data.districts.map(d => ({ district: d.name, winner: [...d.candidates].sort((a,b) => b.score - a.score)[0] }));
            return (
                <div className="px-8 py-2 h-full flex flex-col relative z-10 page-transition">
                    <div className="text-center mb-1 shrink-0"><h2 className="text-[2.5rem] font-bold text-white drop-shadow-md text-shadow thai-text leading-none uppercase">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ú‡∏π‡πâ‡∏•‡∏á‡∏™‡∏°‡∏±‡∏Ñ‡∏£ ‡∏™‡∏™. ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏≥ ‡πÉ‡∏ô‡∏ó‡∏±‡πâ‡∏á 10 ‡πÄ‡∏Ç‡∏ï ‡∏Ç‡∏≠‡∏á‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà</h2><div className="text-[1.4rem] font-normal text-blue-200 opacity-75 mt-3 leading-none italic">(‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£)</div></div>
                    <div className="grid grid-cols-5 grid-rows-2 gap-3 flex-1 h-full min-h-0 py-2">{winners.map((item, idx) => { const partyColor = getColor(item.winner.party); return (<div key={idx} className="glass-panel rounded-[1.4rem] p-2.5 flex flex-col items-center justify-between text-center relative overflow-hidden h-full shadow-2xl transition-transform hover:scale-[1.04]" style={{ background: `radial-gradient(circle at 50% 0%, ${partyColor}33, rgba(2, 6, 23, 0.95))` }}><div className="absolute top-0 left-0 w-full h-1" style={{backgroundColor: partyColor}}></div><div className="w-full flex justify-center mb-1 shrink-0"><div className="bg-white/5 px-4 py-0.5 rounded-full border border-white/10 shadow-sm backdrop-blur-sm"><span className="text-blue-50 text-[1.1rem] font-bold uppercase tracking-wider leading-none drop-shadow-md">{item.district}</span></div></div><div className="relative mb-1 flex-1 flex items-center justify-center w-full min-h-0 px-0.5"><div className="h-full w-auto aspect-[3/4] rounded-md border-2 border-white/20 overflow-hidden shadow-2xl bg-slate-800 relative" style={{borderColor: partyColor}}><img src={item.winner.image || `https://placehold.co/150x200/${partyColor.replace('#','')}/FFFFFF?text=${item.winner.no}`} className="img-fit opacity-95"/><div className="absolute bottom-0 left-1/2 -translate-x-1/2 bg-white text-blue-900 px-2 py-0.5 rounded-full shadow-xl border border-white z-20 whitespace-nowrap text-[12px] font-black">‡πÄ‡∏ö‡∏≠‡∏£‡πå {item.winner.no}</div></div></div><div className="w-full mt-0 pb-1 shrink-0"><div className="text-white text-[1.2rem] font-semibold truncate w-full px-1 thai-text text-shadow leading-none mb-1.5">{item.winner.name}</div><div className={`text-[13px] font-medium px-4 py-0.5 rounded-full border shadow-sm inline-block mx-auto ${getContrastColor(partyColor)}`} style={{ backgroundColor: partyColor }}>{item.winner.party}</div><div className="text-[1.85rem] font-bold text-white text-shadow tracking-normal leading-tight mt-1.5 score-pop">{item.winner.score.toLocaleString()}</div></div></div>); })}</div>
                </div>
            );
        }

        // --- Admin Panel (Updated with Delete & Reset Fixes) ---
        function AdminPanel({ localData, setLocalData, handleScoreChange, handleSettingChange, saveData, handleCandidateInfoChange, handleImageChange, isOnlineMode, saveTriggered, handleBgUpload, setMode, setupError, handleProgressChange, handleDistrictFieldChange }) {
            const [adminFilter, setAdminFilter] = useState('all'); const [imageModalData, setImageModalData] = useState(null); const [isPartyModalOpen, setIsPartyModalOpen] = useState(false); const [autoStatus, setAutoStatus] = useState('idle'); const bgInputRef = useRef(null);
            
            // --- FIX: Robust check for districts array ---
            // If localData or districts is missing/invalid, render nothing or loading
            if (!localData || !localData.districts) return null;

            // SAFEGUARD: Ensure districts is always an array to prevent "map is not a function"
            const districts = Array.isArray(localData.districts) ? localData.districts : [];
            
            const enabledSlides = localData.settings.enabledSlides || ALL_SLIDES; 
            const syncImmediate = async (d) => { if (isOnlineMode) await getDocRef().set(d); };
            const setDisplayModeImmediate = async (m, s = 0) => { setAutoStatus('processing'); const n = { ...localData, settings: { ...localData.settings, displayMode: m, activeSlide: parseInt(s) } }; setLocalData(n); await getDocRef().update({settings: n.settings}); setAutoStatus('success'); setTimeout(() => setAutoStatus('idle'), 2000); };
            const handleLightUpdate = async (f, v) => { const n = { ...localData, settings: { ...localData.settings, [f]: v } }; setLocalData(n); await getDocRef().update({settings: n.settings}); };
            const toggleSlideEnabled = (idx) => { let e = [...(localData.settings.enabledSlides || ALL_SLIDES)]; if (e.includes(idx)) { if (e.length > 1) e = e.filter(s => s !== idx); } else { e.push(idx); e.sort((a,b) => a-b); } handleSettingChange('enabledSlides', e); };
            const setEnabledShortcut = (t) => { let l = []; if (t === 'all') l = [...ALL_SLIDES]; else if (t === 'districts') l = [0,1,2,3,4,5,6,7,8,9]; else if (t === 'summary') l = [10]; handleSettingChange('enabledSlides', l); };

            // --- Admin Specific Actions ---
            const moveCandidate = (districtId, index, direction) => {
                 setLocalData(prevData => {
                    const newData = { ...prevData };
                    const districtIndex = newData.districts.findIndex(d => d.id === districtId);
                    if (districtIndex === -1) return prevData;
                    const candidates = [...newData.districts[districtIndex].candidates];
                    if (index + direction < 0 || index + direction >= candidates.length) return prevData;
                    const temp = candidates[index];
                    candidates[index] = candidates[index + direction];
                    candidates[index + direction] = temp;
                    newData.districts[districtIndex].candidates = candidates;
                    return newData;
                 });
            };

            const addCandidate = (districtId) => {
                setLocalData(prevData => {
                    const newData = { ...prevData };
                    const districtIndex = newData.districts.findIndex(d => d.id === districtId);
                    if (districtIndex === -1) return prevData;
                    const newCandidateNo = newData.districts[districtIndex].candidates.length + 1;
                    const newCandidate = { no: newCandidateNo, name: "‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏´‡∏°‡πà", party: "‡∏≠‡∏¥‡∏™‡∏£‡∏∞", score: 0, image: "" };
                    newData.districts[districtIndex].candidates.push(newCandidate);
                    return newData;
                });
            };

            const deleteCandidate = (districtId, index) => {
                const district = localData.districts.find(d => d.id === districtId);
                const candidateName = district.candidates[index].name;
                
                if (window.confirm(`‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£: ${candidateName}?`)) {
                    // Create deep clone for safety
                    const newData = JSON.parse(JSON.stringify(localData));
                    const dIdx = newData.districts.findIndex(d => d.id === districtId);
                    
                    if (dIdx !== -1) {
                        newData.districts[dIdx].candidates.splice(index, 1);
                        setLocalData(newData);
                        // Auto-save the change using the NEW data
                        saveData(districtId, newData);
                    }
                }
            };

            const resetDistrictScores = (districtId) => {
                if (window.confirm(`üîÑ ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô ‡πÄ‡∏Ç‡∏ï ${districtId} ‡πÄ‡∏õ‡πá‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå?`)) {
                    const newData = JSON.parse(JSON.stringify(localData));
                    const dIdx = newData.districts.findIndex(d => d.id === districtId);
                    
                    if (dIdx !== -1) {
                        newData.districts[dIdx].candidates = newData.districts[dIdx].candidates.map(c => ({...c, score: 0}));
                        newData.districts[dIdx].progress = 0;
                        setLocalData(newData);
                        // Auto-save the change using the NEW data
                        saveData(districtId, newData);
                    }
                }
            };

            const handleScoreKeyDown = (e, districtId, index) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    const nextInputId = `score-${districtId}-${index + 1}`;
                    const nextInput = document.getElementById(nextInputId);
                    if (nextInput) { nextInput.focus(); nextInput.select(); }
                }
            };
            
            const handleExportBackup = () => {
                const dataStr = JSON.stringify(localData, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `election_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleImportBackup = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedData = JSON.parse(event.target.result);
                        setLocalData(importedData);
                        saveData(null, importedData); // Use new save signature
                        alert("‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                    } catch (err) { alert("‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á"); }
                };
                reader.readAsText(file);
            };

            return (
                <div className="h-screen bg-slate-50 flex flex-col overflow-hidden font-sans text-slate-800 relative">
                    {setupError && <div className="bg-red-600 text-white px-6 py-3 text-center text-sm font-bold shadow-lg z-[100] animate-bounce">{setupError}</div>}
                    <ImageUploadModal isOpen={!!imageModalData} onClose={() => setImageModalData(null)} onSave={(d,c,u) => { handleImageChange(d,c,u); setImageModalData(null); }} {...imageModalData} />
                    <PartyColorModal isOpen={isPartyModalOpen} onClose={() => setIsPartyModalOpen(false)} currentColors={localData.partyColors} onUpdate={async (nc) => { const n={...localData, partyColors:nc}; setLocalData(n); await getDocRef().update({partyColors: nc}); }} />
                    <nav className="bg-white border-b px-8 py-3 flex justify-between items-center z-50 shadow-md">
                        <div className="flex items-center gap-3"><button onClick={() => setMode('viewer')} className="bg-slate-100 hover:bg-slate-200 p-2 rounded-lg text-slate-600 transition-colors"><MonitorIcon size={20}/></button><h1 className="text-xl font-black uppercase tracking-tighter">ADMIN PANEL</h1></div>
                        <div className="flex items-center gap-4">
                            <div className="text-[9px] px-3 py-1 rounded-full font-black border uppercase tracking-widest bg-green-50 text-green-600 border-green-200">‚óè Online Real-time</div>
                            <button onClick={() => setIsPartyModalOpen(true)} className="text-xs font-bold text-pink-600 hover:text-pink-700 px-3 py-1.5 bg-pink-50 rounded-lg border border-pink-100 flex items-center gap-2 transition-all hover:scale-105"><PaletteIcon size={14}/> ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏µ‡∏û‡∏£‡∏£‡∏Ñ</button>
                            <button onClick={async () => { await auth.signOut(); }} className="text-xs font-bold text-red-500 hover:text-red-700 px-3 py-1.5 bg-red-50 rounded-lg border border-red-100 flex items-center gap-2 ml-2 transition-all active:scale-95 shadow-lg"><LogoutIcon size={14}/> ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                        </div>
                    </nav>
                    <div className="flex-1 overflow-y-auto admin-scroll p-6">
                        <div className="max-w-7xl mx-auto space-y-6">
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                <div className="bg-white rounded-2xl border-2 border-slate-100 p-5 shadow-lg">
                                    <div className="flex justify-between items-center mb-4"><h3 className="text-sm font-black text-slate-800 uppercase flex items-center gap-2"><SettingsIcon size={18}/> Configuration</h3><button onClick={() => saveData()} className="bg-slate-800 text-white px-5 py-2 rounded-xl text-xs font-black uppercase shadow-lg flex items-center gap-2 transition-all"><SaveIcon size={14}/> Save Settings</button></div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                                        <div className="space-y-1.5 md:col-span-2"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Main Title</label><input type="text" value={localData.settings.title} onChange={(e)=>handleSettingChange('title', e.target.value)} className="w-full border-2 border-slate-50 bg-slate-50 rounded-xl px-4 py-2 text-xs font-bold outline-none shadow-sm"/></div>
                                        <div className="space-y-1.5 md:col-span-2"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Running Text (Footer)</label><input type="text" value={localData.settings.footer} onChange={(e)=>handleSettingChange('footer', e.target.value)} className="w-full border-2 border-slate-50 bg-slate-50 rounded-xl px-4 py-2 text-xs font-bold outline-none shadow-sm"/></div>
                                        
                                        {/* Added URL Input for Background */}
                                        <div className="space-y-1.5 md:col-span-2">
                                            <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Background Image</label>
                                            <div className="flex gap-2">
                                                <input type="text" placeholder="URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á..." value={localData.settings.backgroundImage || ''} onChange={(e) => handleSettingChange('backgroundImage', e.target.value)} className="flex-1 border-2 border-slate-50 bg-slate-50 rounded-xl px-4 py-2 text-xs font-bold outline-none shadow-sm"/>
                                                <label className="bg-blue-600 text-white px-3 py-2 rounded-xl text-xs font-bold cursor-pointer hover:bg-blue-700 whitespace-nowrap flex items-center gap-1 shadow-md"><CameraIcon size={14}/> Upload <input type="file" className="hidden" accept="image/*" onChange={(e) => handleBgUpload(e.target.files[0])}/></label>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-3 gap-4 md:col-span-2">
                                            <div className="space-y-1.5"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Cycle (Sec)</label><input type="number" value={localData.settings.cycleTime || 10} onChange={(e)=>handleSettingChange('cycleTime', parseInt(e.target.value))} className="w-full border-2 border-slate-50 bg-slate-50 rounded-xl px-4 py-2 text-xs font-bold outline-none shadow-sm"/></div>
                                            <div className="space-y-1.5"><label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Marquee Speed</label><input type="number" value={localData.settings.marqueeSpeed || 20} onChange={(e)=>handleSettingChange('marqueeSpeed', parseInt(e.target.value))} className="w-full border-2 border-slate-50 bg-slate-50 rounded-xl px-4 py-2 text-xs font-bold outline-none shadow-sm"/></div>
                                            <div className="space-y-1.5"><label className="text-[10px] font-black text-indigo-500 uppercase tracking-widest ml-1 flex items-center gap-1"><ClockIcon size={10}/> Loop Delay</label><input type="number" value={localData.settings.marqueeDelay || 3} onChange={(e)=>handleSettingChange('marqueeDelay', parseInt(e.target.value))} className="w-full border-2 border-indigo-50 bg-indigo-50 rounded-xl px-4 py-2 text-xs font-bold outline-none shadow-sm" placeholder="‡∏ß‡∏¥"/></div>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-3 bg-blue-50 rounded-2xl border border-blue-100 md:col-span-2">
                                            <div className="space-y-1.5"><label className="text-[10px] font-black text-blue-500 uppercase tracking-widest ml-1">Visual Effect</label><div className="flex items-center gap-2"><button onClick={() => handleLightUpdate('showLightEffect', !localData.settings.showLightEffect)} className={`w-full py-1.5 rounded-lg text-[10px] font-black transition-all shadow-sm ${localData.settings.showLightEffect ? 'bg-blue-600 text-white shadow-md' : 'bg-white text-slate-400 border'}`}>{localData.settings.showLightEffect ? '‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡∏≥‡πÅ‡∏™‡∏á' : '‡∏õ‡∏¥‡∏î‡∏•‡∏≥‡πÅ‡∏™‡∏á'}</button></div></div>
                                            <div className="space-y-1.5"><label className="text-[10px] font-black text-blue-500 uppercase tracking-widest ml-1 flex justify-between items-center"><span>Brightness</span><span className="text-blue-600">{localData.settings.lightBrightness || 70}%</span></label><input type="range" min="0" max="100" value={localData.settings.lightBrightness || 70} onChange={(e) => handleLightUpdate('lightBrightness', parseInt(e.target.value))} className="w-full h-1.5 bg-blue-200 rounded-lg appearance-none cursor-pointer accent-blue-600"/></div>
                                        </div>
                                        <div className="p-3 bg-cyan-50 rounded-2xl border border-cyan-100 md:col-span-2 flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                <div className="p-2 bg-cyan-200 rounded-lg text-cyan-700"><PercentIcon size={20}/></div>
                                                <div>
                                                    <h4 className="text-xs font-black text-cyan-800 uppercase leading-none">‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• % ‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h4>
                                                    <p className="text-[10px] text-cyan-600 mt-1">‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏ä‡∏ß‡πå‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡∏°‡πà‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡∏ü‡πâ‡∏≤</p>
                                                </div>
                                            </div>
                                            <button onClick={() => handleSettingChange('showPercentage', !localData.settings.showPercentage)} className={`px-6 py-2 rounded-xl text-xs font-black transition-all shadow-md ${localData.settings.showPercentage ? 'bg-cyan-600 text-white' : 'bg-white text-slate-400 border'}`}>
                                                {localData.settings.showPercentage ? '‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•' : '‡∏õ‡∏¥‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•'}
                                            </button>
                                        </div>
                                    </div>
                                    <div className="bg-slate-50 border-t-2 border-slate-200 pt-4 mt-6">
                                        <h3 className="text-sm font-black text-slate-800 uppercase flex items-center gap-2 mb-3"><DatabaseIcon size={18}/> Backup & Restore</h3>
                                        <div className="flex gap-3">
                                            <button onClick={handleExportBackup} className="flex-1 bg-slate-600 text-white py-3 rounded-xl font-bold text-xs flex items-center justify-center gap-2 hover:bg-slate-700 transition-all shadow-md active:scale-95"><DownloadIcon size={16}/> Download Backup</button>
                                            <label className="flex-1 bg-white text-slate-600 py-3 rounded-xl font-bold text-xs flex items-center justify-center gap-2 hover:bg-slate-100 transition-all cursor-pointer border-2 border-slate-200 shadow-sm active:scale-95">
                                                <UploadIcon size={16}/> Restore Backup
                                                <input type="file" className="hidden" accept=".json" onChange={handleImportBackup}/>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div className="bg-white rounded-2xl border-2 border-blue-500 p-5 shadow-xl h-fit">
                                    <h3 className="text-sm font-black text-blue-600 uppercase mb-4 flex items-center gap-2"><MonitorIcon size={16}/> Live Monitor</h3>
                                    <div className="space-y-4"><button onClick={() => setDisplayModeImmediate('auto')} disabled={autoStatus === 'processing'} className={`w-full py-3 rounded-xl text-xs font-black shadow transition-all ${ localData.settings.displayMode === 'auto' ? 'bg-green-600 text-white scale-105 ring-4 ring-green-100' : 'bg-slate-100 text-slate-400 hover:bg-slate-200' }`}>‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (AUTO LOOP)</button><div className="flex flex-col gap-1.5"><span className="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Force Specific Slide</span><select value={localData.settings.displayMode === 'fixed' ? localData.settings.activeSlide : -1} onChange={(e) => setDisplayModeImmediate('fixed', e.target.value)} className="w-full bg-slate-50 border-2 rounded-xl px-3 py-2.5 text-xs font-black outline-none transition-all shadow-inner"><option value="-1" disabled>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ç‡∏ï...</option>{districts.map((d, i) => <option key={i} value={i}>{d.name}</option>)}<option value="10">‡∏´‡∏ô‡πâ‡∏≤‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° 10 ‡πÄ‡∏Ç‡∏ï</option></select></div></div>
                                    <h3 className="text-sm font-black text-blue-600 uppercase mb-4 flex items-center gap-2 mt-6"><CheckIcon size={18}/> Playlist Selection</h3>
                                    <div className="grid grid-cols-4 gap-2 mb-4">
                                        {ALL_SLIDES.map(idx => (<button key={idx} onClick={() => toggleSlideEnabled(idx)} className={`py-2 rounded-lg text-[10px] font-bold border transition-all ${enabledSlides.includes(idx) ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-slate-50 text-slate-400 border-slate-200'}`}>{idx === 10 ? '‡∏£‡∏ß‡∏°' : `‡∏Ç.${idx+1}`}</button>))}
                                    </div>
                                    <div className="flex flex-wrap gap-1.5 pt-2 border-t"><button onClick={() => setEnabledShortcut('all')} className="text-[9px] font-black bg-slate-100 px-2 py-1 rounded hover:bg-slate-200">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button><button onClick={() => setEnabledShortcut('districts')} className="text-[9px] font-black bg-slate-100 px-2 py-1 rounded hover:bg-slate-200">1-10</button><button onClick={() => setEnabledShortcut('summary')} className="text-[9px] font-black bg-slate-100 px-2 py-1 rounded hover:bg-slate-200">‡∏™‡∏£‡∏∏‡∏õ</button></div>
                                </div>
                            </div>
                            <div className="flex gap-2 sticky top-0 z-40 bg-white p-3 rounded-2xl shadow border overflow-x-auto">
                                <button onClick={() => setAdminFilter('all')} className={`px-6 py-2 rounded-xl text-xs font-black whitespace-nowrap ${adminFilter === 'all' ? 'bg-slate-800 text-white' : 'bg-slate-100'}`}>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                                <button onClick={() => setAdminFilter('1-5')} className={`px-6 py-2 rounded-xl text-xs font-black whitespace-nowrap ${adminFilter === '1-5' ? 'bg-blue-600 text-white' : 'bg-slate-100'}`}>‡πÄ‡∏Ç‡∏ï 1-5</button>
                                <button onClick={() => setAdminFilter('6-10')} className={`px-6 py-2 rounded-xl text-xs font-black whitespace-nowrap ${adminFilter === '6-10' ? 'bg-indigo-600 text-white' : 'bg-slate-100'}`}>‡πÄ‡∏Ç‡∏ï 6-10</button>
                            </div>
                            <div className="space-y-10 pb-60">{districts.filter(d => { if (adminFilter === '1-5') return d.id >= 1 && d.id <= 5; if (adminFilter === '6-10') return d.id >= 6 && d.id <= 10; return true; }).map((d) => (
                                <div key={d.id} className="bg-white rounded-3xl border-2 shadow-md overflow-hidden border-slate-200">
                                    <div className="bg-slate-100/50 px-8 py-4 border-b-2 flex flex-wrap justify-between items-center gap-4">
                                        <div className="flex flex-col gap-2 w-full md:w-auto flex-1">
                                            <div className="flex flex-wrap items-center gap-4">
                                                <h3 className="font-black text-2xl text-slate-700 uppercase">{d.name}</h3>
                                                <div className="flex items-center gap-2 bg-cyan-50 px-3 py-1.5 rounded-xl border border-cyan-100">
                                                    <span className="text-[10px] font-black text-cyan-700 uppercase tracking-widest">‡∏ô‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß % :</span>
                                                    <input type="number" min="0" max="100" value={d.progress || 0} onChange={(e) => handleProgressChange(d.id, e.target.value)} onFocus={(e) => e.target.select()} className="w-16 text-center font-black text-cyan-900 bg-white border rounded shadow-inner outline-none focus:border-cyan-400" />
                                                </div>
                                                <span className={`text-[10px] font-black border-2 px-3 py-1 rounded-full uppercase bg-white`}>Sync: {d.lastUpdated || 'No Data'}</span>
                                            </div>
                                            {/* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ */}
                                            <div className="w-full mt-1">
                                                <textarea 
                                                    value={d.area || ''} 
                                                    onChange={(e) => handleDistrictFieldChange(d.id, 'area', e.target.value)} 
                                                    placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≥‡πÄ‡∏†‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô ‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á, ‡∏≠.‡∏´‡∏≤‡∏á‡∏î‡∏á) | ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà" 
                                                    className="w-full text-xs p-2 rounded border bg-white/50 focus:bg-white transition-all outline-none resize-none h-auto min-h-[40px] shadow-inner" 
                                                    rows={1}
                                                />
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-2 mt-2 md:mt-0">
                                            <button onClick={() => resetDistrictScores(d.id)} className="bg-amber-100 text-amber-700 hover:bg-amber-200 px-4 py-2.5 rounded-xl text-xs font-black uppercase flex items-center gap-2 transition-all border border-amber-200"><RotateCcwIcon size={14}/> Reset ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                                            <button onClick={() => saveData(d.id)} className="bg-green-600 text-white hover:bg-green-700 px-8 py-2.5 rounded-xl text-sm font-black uppercase shadow-xl active:scale-95 transition-all">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å {d.name}</button>
                                        </div>
                                    </div>
                                    <div className="p-6 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 bg-slate-50/30">{d.candidates.map((c, idx) => (
                                        <div key={idx} className="flex items-center gap-3 border p-3 rounded-xl bg-white hover:border-blue-400 shadow-sm relative group">
                                            <div className="flex flex-col gap-1 mr-1">
                                                <button onClick={() => moveCandidate(d.id, idx, -1)} disabled={idx === 0} className="p-1 hover:bg-slate-100 rounded text-slate-400 hover:text-blue-500 disabled:opacity-30"><ArrowUpIcon size={12}/></button>
                                                <button onClick={() => deleteCandidate(d.id, idx)} className="p-1 hover:bg-red-50 rounded text-slate-300 hover:text-red-500 transition-colors"><TrashIcon size={12}/></button>
                                                <button onClick={() => moveCandidate(d.id, idx, 1)} disabled={idx === d.candidates.length - 1} className="p-1 hover:bg-slate-100 rounded text-slate-400 hover:text-blue-500 disabled:opacity-30"><ArrowDownIcon size={12}/></button>
                                            </div>
                                            <div onClick={() => setImageModalData({ districtId: d.id, candidateNo: c.no, initialUrl: c.image })} className="shrink-0 w-12 h-16 rounded bg-slate-100 border overflow-hidden cursor-pointer hover:opacity-80 transition-opacity relative">
                                                <img src={c.image || `https://placehold.co/100x133/${localData.partyColors[c.party]?.replace('#','') || '64748b'}/FFFFFF?text=${c.no}`} className="w-full h-full object-cover"/>
                                                <div className="absolute inset-0 flex items-center justify-center bg-black/20 opacity-0 group-hover:opacity-100 transition-opacity"><CameraIcon size={16} className="text-white drop-shadow-md"/></div>
                                            </div>
                                            <div className="flex-1 min-w-0 pr-2 space-y-1">
                                                <div className="flex items-center gap-2">
                                                    <input type="text" value={c.no} onChange={(e)=>handleCandidateInfoChange(d.id, idx, 'no', e.target.value)} className="w-8 text-[11px] font-black bg-slate-50 rounded text-center border border-slate-200 focus:border-blue-500 outline-none p-0.5" />
                                                    <input type="text" value={c.name} onChange={(e)=>handleCandidateInfoChange(d.id, idx, 'name', e.target.value)} className="flex-1 text-xs font-bold border-b border-transparent hover:border-slate-300 focus:border-blue-500 outline-none truncate bg-transparent p-0.5" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£" />
                                                </div>
                                                <input type="text" value={c.party} onChange={(e)=>handleCandidateInfoChange(d.id, idx, 'party', e.target.value)} className="w-full text-[10px] text-slate-500 border-b border-transparent hover:border-slate-300 focus:border-blue-500 outline-none bg-transparent p-0.5" placeholder="‡∏û‡∏£‡∏£‡∏Ñ" />
                                            </div>
                                            <input id={`score-${d.id}-${idx}`} type="number" value={c.score.toString()} onChange={(e)=>handleScoreChange(d.id, c.no, e.target.value)} onFocus={(e)=>e.target.select()} onKeyDown={(e) => handleScoreKeyDown(e, d.id, idx)} className="w-20 text-right border-2 border-slate-100 rounded-lg px-2 py-1.5 font-black text-lg text-blue-700 outline-none shadow-inner focus:border-blue-500 transition-all" />
                                        </div>
                                    ))}
                                        <button onClick={() => addCandidate(d.id)} className="col-span-full border-2 border-dashed border-slate-300 rounded-xl py-3 flex items-center justify-center text-slate-400 hover:text-blue-500 hover:border-blue-500 hover:bg-blue-50 transition-all gap-2 text-xs font-bold">
                                            <PlusIcon size={16}/> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡πÉ‡∏ô‡πÄ‡∏Ç‡∏ï‡∏ô‡∏µ‡πâ
                                        </button>
                                    </div>
                                </div>
                            ))}</div>
                        </div>
                    </div>
                    {saveTriggered && <div className="fixed bottom-10 right-10 z-[100] bg-green-600 text-white px-8 py-4 rounded-3xl shadow-2xl flex items-center gap-4 save-status-pop border-4 border-white/20 font-black uppercase tracking-widest">Saved & Synced</div>}
                </div>
            );
        }

        // --- Main App Component ---
        function App() {
            const urlParams = new URLSearchParams(window.location.search);
            const [mode, setMode] = useState(urlParams.get('mode') === 'admin' ? 'admin' : 'viewer');
            const [data, setData] = useState(null);
            const [localData, setLocalData] = useState(null);
            const [user, setUser] = useState(null);
            const [slideIndex, setSlideIndex] = useState(0);
            const [saveTriggered, setSaveTriggered] = useState(false);
            const [marqueeKey, setMarqueeKey] = useState(0);
            const [setupError, setSetupError] = useState(null);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((u) => { 
                    setUser(u);
                    if (!u) {
                        getDocRef().onSnapshot((doc) => {
                            if (doc.exists) { setData(doc.data()); setLocalData(JSON.parse(JSON.stringify(doc.data()))); }
                            else { getDocRef().set(INITIAL_DATA); }
                        }, (err) => console.error(err));
                    }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (user) {
                    const unsubscribe = getDocRef().onSnapshot((doc) => {
                        if (doc.exists) { 
                            const cloudData = doc.data();
                            setData(cloudData); 
                            // --- FIX: Initialize localData for admin if not set ---
                            if (mode !== 'admin' || !localData) setLocalData(cloudData); 
                        } else getDocRef().set(INITIAL_DATA);
                    }, (err) => { if (err.code === 'permission-denied') setSetupError("‚ö†Ô∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase Rules ‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå!"); });
                    return () => unsubscribe();
                }
            }, [user, mode]);

            useEffect(() => {
                if (mode === 'viewer' && data) {
                    if (data.settings?.displayMode === 'fixed') setSlideIndex(parseInt(data.settings?.activeSlide || 0));
                    else { 
                        const enabled = data.settings?.enabledSlides || ALL_SLIDES;
                        if (!enabled.includes(slideIndex)) setSlideIndex(enabled[0] || 0);
                        const interval = setInterval(() => {
                            setSlideIndex((current) => {
                                if (enabled.length === 0) return current;
                                const curIdx = enabled.indexOf(current);
                                const nextIdx = (curIdx + 1) % enabled.length;
                                return enabled[nextIdx];
                            });
                        }, (data.settings?.cycleTime || 10) * 1000); 
                        return () => clearInterval(interval); 
                    }
                }
            }, [mode, data?.settings?.displayMode, data?.settings?.activeSlide, data?.settings?.cycleTime, data?.settings?.enabledSlides]);

            useEffect(() => {
                if (data?.settings?.footer) {
                    const speed = (data.settings?.marqueeSpeed || 20) * 1000;
                    const delay = (data.settings?.marqueeDelay || 3) * 1000;
                    const timer = setInterval(() => setMarqueeKey(k => k + 1), speed + delay);
                    return () => clearInterval(timer);
                }
            }, [data?.settings?.footer, data?.settings?.marqueeSpeed, data?.settings?.marqueeDelay]);

            const handleScoreChange = (distId, cNo, val) => { const score = val === '' ? 0 : parseInt(val); setLocalData(p => ({...p, districts: p.districts.map(d => d.id === distId ? {...d, candidates: d.candidates.map(c => c.no === cNo ? {...c, score: isNaN(score) ? c.score : score} : c)} : d)})); };
            const handleProgressChange = (distId, val) => { const prog = val === '' ? 0 : parseInt(val); setLocalData(p => ({...p, districts: p.districts.map(d => d.id === distId ? {...d, progress: isNaN(prog) ? d.progress : prog} : d)})); };
            const handleDistrictFieldChange = (distId, field, val) => { setLocalData(p => ({...p, districts: p.districts.map(d => d.id === distId ? {...d, [field]: val} : d)})); };
            const handleCandidateInfoChange = (distId, cIdx, field, val) => { setLocalData(p => ({ ...p, districts: p.districts.map(d => { if (d.id !== distId) return d; const newCandidates = [...d.candidates]; newCandidates[cIdx] = { ...newCandidates[cIdx], [field]: val }; return { ...d, candidates: newCandidates }; }) })); };
            const handleSettingChange = (field, val) => { setLocalData(p => ({...p, settings: {...p.settings, [field]: val}})); };
            const handleImageChange = (distId, cNo, url) => { setLocalData(p => ({...p, districts: p.districts.map(d => d.id === distId ? {...d, candidates: d.candidates.map(c => c.no === cNo ? {...c, image: url} : c)} : d)})); };
            
            const handleBgUpload = (file) => {
                if(!file) return; const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                        const scale = Math.min(1, 1920 / img.width); canvas.width = img.width * scale; canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height); handleSettingChange('backgroundImage', canvas.toDataURL('image/jpeg', 0.85));
                    };
                }; reader.readAsDataURL(file);
            };

            // *** FIXED SAVE LOGIC: READ-MERGE-WRITE to prevent race conditions ***
            const saveData = async (distId = null, overrideData = null) => {
                // Use overrideData if provided (for instant delete/reset), otherwise use current localData
                const dataToSave = overrideData || localData;
                
                if (!dataToSave) return; 
                try {
                    // 1. Get latest data from server first (to avoid overwriting others)
                    const docRef = getDocRef();
                    const docSnap = await docRef.get();
                    
                    if (!docSnap.exists) {
                        // Edge case: data missing
                         await docRef.set(dataToSave);
                         return;
                    }
                    const serverData = docSnap.data();

                    let updatePayload = {};

                    if (distId) {
                        // --- Saving Specific District: MERGE Logic ---
                        // Get the fresh district array from server
                        const currentDistricts = serverData.districts || [];
                        const districtIndex = currentDistricts.findIndex(d => d.id === distId);
                        
                        // Get OUR local version of this district
                        const localDistData = dataToSave.districts.find(d => d.id === distId);

                        if (districtIndex !== -1 && localDistData) {
                            const now = new Date(); 
                            const timeStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`; 
                            
                            // Create updated district object
                            const distToSave = { ...localDistData, lastUpdated: timeStr };

                            // Update ONLY this index in the server's array
                            currentDistricts[districtIndex] = distToSave;

                            // Payload is the array with ONE updated item, rest are from server
                            updatePayload = { districts: currentDistricts };
                            
                            // Update local timestamp so UI reflects it immediately
                            if (!overrideData) { // If it's a manual save, update local timestamp
                                 setLocalData(prev => ({
                                    ...prev,
                                    districts: prev.districts.map(d => d.id === distId ? distToSave : d)
                                }));
                            }
                        }
                    } else {
                        // --- Saving Global Settings ---
                        // Update only settings & colors fields, DO NOT touch districts
                        updatePayload = {
                            settings: dataToSave.settings,
                            partyColors: dataToSave.partyColors
                        };
                    }

                    // 2. Write back the merged payload
                    await docRef.update(updatePayload);

                    setSaveTriggered(true); setTimeout(() => setSaveTriggered(false), 2000); 
                } 
                catch(e) { 
                    console.error(e);
                    alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message); 
                }
            };

            if (!data) return <div className="h-screen w-screen bg-slate-900 flex items-center justify-center text-white flex-col gap-4"><div className="loader"></div><div>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div></div>;
            if (mode === 'admin') {
                if (!user || user.isAnonymous) return <LoginScreen />;
                return <AdminPanel localData={localData} setLocalData={setLocalData} handleScoreChange={handleScoreChange} handleSettingChange={handleSettingChange} saveData={saveData} handleCandidateInfoChange={handleCandidateInfoChange} handleImageChange={handleImageChange} isOnlineMode={true} saveTriggered={saveTriggered} handleBgUpload={handleBgUpload} setMode={setMode} setupError={setupError} handleProgressChange={handleProgressChange} handleDistrictFieldChange={handleDistrictFieldChange} />;
            }

            return (
                <div className="dashboard-container relative select-none live-viewer">
                    <div className="bg-animated-container">
                        {data.settings?.backgroundImage && <div className="absolute inset-0 bg-cover bg-center" style={{backgroundImage: `url(${data.settings?.backgroundImage})`}}></div>}
                        {data.settings?.showLightEffect && <div style={{ opacity: (data.settings?.lightBrightness || 70) / 100 }}><div className="beam beam-1"></div><div className="beam beam-2"></div><div className="beam beam-3"></div></div>}
                    </div>
                    <header className="glass-panel flex justify-between items-center px-8 z-20 cursor-default">
                        <h1 className="text-2xl font-bold text-white thai-text drop-shadow-md uppercase truncate max-w-[70%]">{data.settings?.title}</h1>
                        {/* Modified Clock: Open new tab for admin */}
                        <Clock onClick={() => window.open(window.location.pathname + '?mode=admin', '_blank')} />
                    </header>
                    <main className="overflow-hidden relative" key={slideIndex}>
                        {slideIndex < 10 ? <DistrictView district={data.districts[slideIndex]} partyColors={data.partyColors} showPercentage={data.settings?.showPercentage} /> : <SummaryView data={data} partyColors={data.partyColors} />}
                    </main>
                    <footer className="bg-slate-900/60 backdrop-blur-xl text-white flex items-center overflow-hidden z-20 border-t border-white/10 h-[45px] cursor-default shadow-[0_-5px_20px_rgba(0,0,0,0.5)]">
                        <div className="bg-red-600 h-full px-8 flex items-center font-black text-[1.4rem] shrink-0 z-10 text-white thai-text shadow-[5px_0_15px_rgba(0,0,0,0.3)] uppercase">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div>
                        <div className="whitespace-nowrap overflow-hidden flex-1 relative h-full flex items-center">
                            <div key={marqueeKey} className="absolute left-0 w-max text-[1.25rem] font-medium thai-text opacity-90" style={{ animation: `marquee ${data.settings?.marqueeSpeed || 20}s linear forwards` }}>{data.settings?.footer}</div>
                        </div>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
